/*!
Time Range Slider
Copyright 2018 CCRi.
*/
angular.module("ccri.time-range-slider",[]).directive("timeRangeSlider",["$timeout","$window","$log",function(a,b,c){var d="ccri.time-range-slider: ";c.debug(d+"initializing");var e=function(e,f,g){function h(){var a,b,c=!1;A=D,B=E,t(),u(),A!==D&&(a=T.scale(),b=T.translate(),T.x(N.domain(P.domain()).range([0,F])).scale(a).translate(b),P.range(N.range()),J.attr("width",""+F+"px"),i(),c=!0),B!==E&&(Q.range([G,0]),z.attr("height",E+"px"),J.attr("height",""+G+"px"),K.selectAll("rect").attr("height",G),z.selectAll("g.axis").attr("transform","translate(0, "+G+")"),c=!0),c&&(m(),o())}function i(){e.isHidden||(R.tickValues(N.domain()),L.call(R),j())}function j(){var a=L.selectAll("text").style("text-anchor",function(a,b){return 0===b?"start":"end"});if(a.length>0&&a[0].length>1){var b=[a[0][0].getBoundingClientRect().width+I,F-a[0][1].getBoundingClientRect().width-I];O.range(b).domain(b.map(N.invert)).ticks(Math.max((b[1]-b[0])/50,2)),M.call(S)}}function k(){T.x(N.domain([e.min,e.max])),P.domain(N.domain())}function l(a){e.isHidden||_.isUndefined(a)||(k(),i(),o(),m())}function m(){e.isHidden||_.each(e.backgroundPlotters,function(a){a(J,N,Q)})}function n(){e.isHidden||_.isUndefined(e.start)||_.isUndefined(e.end)||(U.extent([e.start,e.end]),C=U.extent(),o())}function o(){e.isHidden||_.isUndefined(e.start)||_.isUndefined(e.end)||(U=U.extent([e.start,e.end]),K.call(U))}function p(){g.start&&g.window&&g.end?(c.debug(d+"using start and end as read/write properties"),e.readOnly="window",c.warn(d+'all three of (start, end, window) are defined; treating window as read-only. To suppress this message add the attribute read-only="window"')):g.start&&g.end?(c.debug(d+"using start and end as read/write properties"),e.readOnly="window"):g.start&&g.window?(c.debug(d+"using start and window as read/write properties"),e.readOnly="end"):g.window&&g.end?(c.debug(d+"using end and window as read/write properties"),e.readOnly="start"):c.error(d+"you should define two of (start, window, end)")}function q(){b.requestAnimationFrame(h)}function r(){return f.height()-5}function s(){return f.width()}function t(){D=s(),F=D-1}function u(){E=r(),G=E-H}function v(){return d3.time.format.utc.multi([[".%L",function(a){return a.getMilliseconds()}],[":%S",function(a){return a.getSeconds()}],["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getUTCHours()}],["%a %d",function(a){return a.getUTCDay()&&1!==a.getUTCDate()}],["%b %d",function(a){return 1!==a.getUTCDate()}],["%B",function(a){return a.getUTCMonth()}],["%Y",function(){return!0}]])}function w(){var a=F/((N.domain()[1].getTime()-N.domain()[0].getTime())*T.scale()),b=-((N.domain()[0].getTime()-N.domain()[1].getTime())*T.scale()+(e.max-(e.max-F/a))),c=-(N.domain()[0].getTime()-N.domain()[1].getTime()+(e.max-e.min))*a*T.scale(),d=N.domain()[0]<e.min?b:N.domain()[1]>e.max?c:T.translate()[0];return[d,0]}var x=e.$on("$destroy",function(){x(),x=null,V&&V.off("resize",q),_.each(y,function(a){a()}),y=null,e=f=null}),y=[],z=d3.select(f.children("svg")[0]);z.attr("height",r()+"px"),_.isEmpty(e.title)||z.append("title").text(e.title);var A,B,C,D=0,E=0,F=0,G=0,H=20,I=20,J=z.append("g"),K=z.append("g").attr("class","brush"),L=z.append("g").attr("class","axis outer-axis"),M=z.append("g").attr("class","axis inner-axis"),N=d3.time.scale.utc().range([0,F]),O=d3.time.scale.utc().range(N.range()),P=d3.time.scale.utc().range(N.range()),Q=d3.scale.linear().range([G,0]).domain([0,1]),R=d3.svg.axis().scale(N).tickValues(N.domain()).tickFormat(d3.time.format.utc("%Y-%m-%dT%H:%M:%SZ")),S=d3.svg.axis().scale(O).ticks(6).tickFormat(v()),T=d3.behavior.zoom().x(N).scaleExtent([1,20]).on("zoomstart",function(){C=U.extent()}).on("zoom",function(){T.translate(w()),m(),U.extent(C),o(),i()}).on("zoomend",function(){U.extent(C),o(),i()});z.call(T);var U=d3.svg.brush().x(N).on("brushstart",function(){d3.event.sourceEvent.stopPropagation(),e.dragStart()}).on("brush",function(){e.$apply(function(){var a=U.extent();e.start=a[0].getTime(),e.end=a[1].getTime(),e.window=e.end-e.start}),e.onChange()}).on("brushend",function(){e.dragEnd()});y.push(e.$watch("isHidden",function(b){b||a(function(){k(),o(),h(),i(),n()},1)})),y.push(e.$watch("min",l)),y.push(e.$watch("max",l)),e.readOnly?["start","window","end"].some(function(a){return a===e.readOnly})||(c.warn("readOnly should be one of (start, window, end)"),p()):p(),"window"===e.readOnly?(y.push(e.$watch("start",n)),y.push(e.$watch("end",n))):"end"===e.readOnly?(y.push(e.$watch("start",function(a){_.isUndefined(a)||_.isUndefined(e.window)?e.end=void 0:e.end=a+e.window,n()})),y.push(e.$watch("window",function(a){_.isUndefined(e.start)||_.isUndefined(a)?e.end=void 0:e.end=e.start+a,n()}))):"start"===e.readOnly&&(y.push(e.$watch("end",function(a){_.isUndefined(a)||_.isUndefined(e.window)?e.start=void 0:e.start=a-e.window,n()})),y.push(e.$watch("window",function(a){_.isUndefined(e.end)||_.isUndefined(a)?e.start=void 0:e.start=e.end-a,n()})));var V=angular.element(b);V.on("resize",q)};return{restrict:"E",scope:{start:"=?",end:"=?",window:"=?",min:"=",max:"=",isHidden:"=?",readOnly:"@",backgroundPlotters:"=?",dragStart:"&",dragEnd:"&",onChange:"&",title:"@?"},template:'<svg class="windowSlider"></svg>',link:e}}]);