/*!
Sonic.js v1.0.3
Copyright 2017 Commonwealth Computer Research, Inc.
Licensed under the Apache License, Version 2.0 (https://git.ccri.com/ccri/sonic.js/blob/master/LICENSE).
*/
!function(){function a(){var a=sonic.argsToArr(arguments);return a[0].componentSingleton().add.apply(null,a.slice(1))}function b(){var a=sonic.argsToArr(arguments);return a[0].componentSingleton().findAll.apply(null,a.slice(1))}function c(){var a=sonic.argsToArr(arguments);return a[0].componentSingleton().findOne.apply(null,a.slice(1))}function d(){var a=sonic.argsToArr(arguments);return a[0].componentSingleton().find.apply(null,a.slice(1))}function e(){var a=sonic.argsToArr(arguments);return a[0].componentSingleton().remove.apply(null,a.slice(1))}function f(a,b){a.listenerSingleton().add(b)}function g(a,b){a.listenerSingleton().remove(b)}function h(a,b){a.tooltipSingleton().add(b)}function i(a,b){a.tooltipSingleton().remove(b)}function j(a,b){a.tooltipSingleton().show(b)}function k(a,b){a.tooltipSingleton().hide(b)}function l(a,b){var c=[];return a.forEach(function(a){var d;b.series&&-1===b.series.indexOf(a.key)||sonic.isArray(a.values)&&0!==a.values.length&&(d=d3.extent(a.values,function(a){return a[b.dataKey]}),sonic.isSet(d[0])&&(sonic.isSet(c[0])?c[0]=Math.min(d[0],c[0]):c[0]=d[0]),sonic.isSet(d[1])&&(sonic.isSet(c[1])?c[1]=Math.max(d[1],c[1]):c[1]=d[1]))}),sonic.isSet(b.min)&&"none"!==b.min&&(c[0]=b.min),sonic.isSet(b.max)&&"none"!==b.max&&(c[1]=b.max),c}function m(a,b,c){var d;return sonic.isArray(c)?(d=c.map(function(c){var d,e=c;return(sonic.isString(c)||sonic.isNumber(c)&&1>=c)&&(sonic.isString(c)&&c.match(/%/)&&(d=parseInt(c.replace(/%/,""),10)/100),sonic.isNumber(c)&&(d=c),e="left"===b||"right"===b?d*a.body().height():d*a.body().width()),e}),("left"===b||"right"===b)&&(d=d3.permute(d,[1,0]))):d="left"===b||"right"===b?[a.body().height(),0]:[0,a.body().width()],d}function n(a){return Math.abs(a.rangeMax()-a.rangeMin())}function o(a,b){a.body().call(sonic.heatmap(a,b))}function p(a,b,c){a.find("sonic-heatmap",b).forEach(function(a){a.mergeConfig(a),a.update()})}function q(a,b){a.body().call(sonic.point(a,b))}function r(a,b){a.remove("sonic-point",b)}function s(a,b,c){a.find("sonic-point",b).forEach(function(a){a.mergeConfig(c),a.update()})}function t(a,b,c){a.find("sonic-point",b).forEach(function(a){a.updatePoint(c)})}function u(a,b){a.body().call(sonic.network(a,b))}function v(a,b){a.remove("sonic-network",b)}function w(a,b,c){a.find("sonic-network",b).forEach(function(a){a.mergeConfig(c),a.update()})}function x(a,b){a.body().call(sonic.tree(a,b))}function y(a,b){a.remove("sonic-tree",b)}function z(a,b,c){a.find("sonic-tree",b).forEach(function(a){a.mergeConfig(c),a.update()})}function A(a,b){a.body().call(sonic.boxAndWhisker(a,b))}function B(a,b,c){a.find("sonic-box-and-whisker",b).forEach(function(a){a.mergeConfig(c),a.update()})}function C(a,b){a.remove("sonic-box-and-whisker",b)}function D(a,b){a.body().call(sonic.line(a,b))}function E(a,b){a.remove("sonic-line",b)}function F(a,b,c){a.find("sonic-line",b).forEach(function(a){a.mergeConfig(c),a.update()})}function G(a,b){a.body().call(sonic.line.difference(a,b))}function H(a,b){a.remove("sonic-difference",b)}function I(a,b){a.body().call(sonic.line.forecast(a,b))}function J(a,b){a.body().call(sonic.line.rule(a,b))}function K(a,b){a.remove("sonic-rule",b)}function L(a,b){J(a,sonic.object.merge({type:"x",followMouse:!0,stroke:"#4CC417"},b)),J(a,sonic.object.merge({type:"y",followMouse:!0,stroke:"#4CC417"},b))}function M(a,b,c){a.find("sonic-rule",b).forEach(function(a){a.mergeConfig(c),a.update()})}function N(a,b){a.body().call(sonic.bar(a,b))}function O(a,b,c,d){var e=d||"sonic-bar";a.find(e,b).forEach(function(a){a.mergeConfig(c),a.update()})}function P(a,b){a.remove("sonic-bar",b)}function Q(a,b){a.body().call(sonic.bar.significance(a,b))}function R(a,b,c){a.find("sonic-significance-bar",b).forEach(function(a){a.mergeConfig(c),a.update()})}function S(a,b){a.body().call(sonic.bar.overlay(a,b))}function T(a,b){a.remove("sonic-bar-overlay",b)}function U(a,b,c,d){var e=d||"sonic-bar-overlay";a.find(e,b).forEach(function(a){a.mergeConfig(c),a.update()})}function V(a,b){a.body().call(sonic.bar.matrix(a,b))}function W(a,b){a.body().call(sonic.comet(a,b))}function X(a,b){a.remove("sonic-comet",b)}function Y(a,b,c){a.find("sonic-comet",b).forEach(function(a){a.mergeConfig(c),a.update()})}function Z(a,b){a.body().call(sonic.area(a,b))}function $(a,b,c){a.find("sonic-area",b).forEach(function(a){a.mergeConfig(c),a.update()})}function _(a,b){a.remove("sonic-area",b)}function aa(a,b){a.body().call(sonic.pie(a,b))}function ba(a,b){a.body().call(sonic.hpie(a,b))}function ca(a,b,c){a.find("sonic-hpie",b).forEach(function(a){a.highlightSlices(c)})}function da(a,b){a.body().call(sonic.punchcard(a,b))}function ea(a,b){a.remove("sonic-punchcard",b)}function fa(a,b,c){a.find("sonic-punchcard",b).forEach(function(a){a.mergeConfig(c),a.update()})}function ga(a,b){a.body().call(sonic.geo.choropleth(a,b))}function ha(a,b,c){a.find("sonic-choropleth",b).forEach(function(a){a.mergeConfig(c),a.update()})}function ia(a,b){a.remove("sonic-choropleth",b)}function ja(a,b){a.body().call(sonic.legend(a,b))}function ka(a,b){a.remove("sonic-legend",b)}function la(a,b,c){a.find("sonic-legend",b).forEach(function(a){a.mergeConfig(c),a.update()})}sonic={},sonic.augment=function(){var a=sonic.argsToArr(arguments),b=a.shift(),c=a.shift(),d=a.shift();a.forEach(function(a){var e=sonic.object.getProp(sonic,a)(b,c,d);sonic.each(e,function(c,d){sonic.isFunction(d)?sonic.isSet(sonic.object.getProp(b,c))?sonic.object.getProp(b,c).override||console.error(new Error("The fn "+c+" of mixin "+a+"is already defined. Please specify override or reconsider the naming of the fn").stack):sonic.object.setProp(b,c,function(){return d.apply(b,arguments)}):sonic.isSet(sonic.object.getProp(b,c))?(sonic.object.merge(d,sonic.object.getProp(b,c)),sonic.object.merge(sonic.object.getProp(b,c),d)):sonic.object.setProp(b,c,d)})})},sonic.override=function(a){return a.override=!0,a},sonic.timezone="UTC",sonic.isSet=function(a){return void 0!==a&&null!==a?!0:!1},sonic.isBoolean=function(a){return"[object Boolean]"===Object.prototype.toString.call(a)},sonic.isNumber=function(a){return"[object Number]"===Object.prototype.toString.call(a)},sonic.isString=function(a){return"[object String]"===Object.prototype.toString.call(a)},sonic.isObject=function(a){return"[object Object]"===Object.prototype.toString.call(a)},sonic.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},sonic.isFunction=function(a){return"[object Function]"===Object.prototype.toString.call(a)},sonic.isDate=function(a){return"[object Date]"===Object.prototype.toString.call(a)},sonic.isRegex=function(a){return a instanceof RegExp},sonic.isNest=function(a){return sonic.isArray(a)&&a.length>0&&sonic.isSet(a[0].key)&&sonic.isSet(a[0].values)?!0:!1},sonic.cleanIdForSelector=function(a){return a.replace(/[+]/g,"plus")},sonic.random=function(a,b){return Math.random()*(b-a)+a},sonic.randomInteger=function(a,b){return Math.round(sonic.random(a,b))},sonic.doIfSet=function(a,b){sonic.isSet(b)&&a(b)},sonic.getOrSet=function(a,b,c,d){return sonic.isSet(b)?(sonic.isObject(c[a])&&sonic.isObject(b)?sonic.object.merge(c[a],b):c[a]=b,d?d:c):c[a]},sonic.clone=function(a){var b,c;if(!sonic.isSet(a))return a;if(sonic.isDate(a))return new Date(a.getTime());if(sonic.isArray(a)){b=a.length-1,c=[];do c[b]=sonic.clone(a[b]),b-=1;while(b>=0)}return sonic.isObject(a)&&(c={},sonic.each(a,function(a,b){c[a]=sonic.clone(b)})),c||a},sonic.string={},sonic.capFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},sonic.string.isNumeric=function(a,b){var c="^[0-9]*[.]{0,1}[0-9]+$";return b&&(c="^[0-9]+$"),RegExp(c).test(a)},sonic.array={},Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c,d;for(c=b||0,d=this.length;d>c;c+=1)if(this[c]===a)return c;return-1}),sonic.argsToArr=function(){var a=arguments;return Array.prototype.slice.call(a[0],0)},sonic.sortByProp=function(a,b){return function(c,d){var e=sonic.object.getProp(c,a),f=sonic.object.getProp(d,a);return sonic.isDate(e)&&(e=e.getTime()),sonic.isDate(f)&&(f=f.getTime()),f>e?b?1:-1:e>f?b?-1:1:0}},sonic.array.maxLength=function(a){return a.reduce(function(a,b){return Math.max(a,sonic.isArray(b)?b.length:b.values.length)},0)},sonic.array.random=function(a){return sonic.isArray(a)&&0!==a.length?a[sonic.randomInteger(0,a.length-1)]:void 0},sonic.array.remove=function(a,b){var c=a.indexOf(b);c>=0&&a.splice(c,1)},sonic.array.add=function(a,b,c){c&&a.indexOf(b)>=0||a.push(b)},sonic.array.contains=function(a,b){var c;return a?c=sonic.isDate(b)?a.some(function(a){return sonic.isDate(a)&&a.getTime()===b.getTime()}):-1!==a.indexOf(b):!1},sonic.array.pluck=function(a,b){return a.map(function(a){return sonic.object.getProp(a,b)})},sonic.array.binarySearch=function(a,b){for(var c,d,e=0,f=a.length-1;f>=e;)if(c=Math.floor((e+f)/2),d=b(a[c]),0>d)e=c+1;else{if(!(d>0))return c;f=c-1}return null},sonic.array.find=function(a,b){return a.filter(function(a){var c=!0;return sonic.each(b,function(b,d){var e=sonic.object.getProp(a,b),f=d;return sonic.isFunction(d)&&(f=d()),e!==f?(c=!1,!1):void 0}),c})},sonic.array.findOne=function(a,b){var c=sonic.array.find(a,b);return 0===c.length?null:c[0]},sonic.array.unique=function(a){return sonic.isArray(a)&&!sonic.isArray(a[0])&&(a=[a]),a.reduce(function(a,b){return a.concat(b.filter(function(b){return!sonic.array.contains(a,b)}))},[])},sonic.object={},sonic.each=function(a,b,c){var d,e;for(d in a)if(a.hasOwnProperty(d)&&(e=b.call(c||a[d],d,a[d]),e===!1))return},sonic.object.keys=function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c},sonic.object.values=function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c},sonic.object.merge=function(a,b){var c;if(b)for(c in b)b.hasOwnProperty(c)&&(sonic.isObject(a[c])&&sonic.isObject(b[c])?sonic.object.merge(a[c],b[c]):a[c]=b[c]);return a},sonic.object.equalize=function(a,b){sonic.object.merge(b,sonic.object.merge(a,b))},sonic.object.getProp=function(a,b){var c=a;return b.split(".").forEach(function(a){c=c[a]}),c},sonic.object.setProp=function(a,b,c){var d=a,e=b.split("."),f=e.pop();return e.forEach(function(a){d=d[a],sonic.isSet(d)||(d[a]={},d=d[a])}),d[f]=c,a},sonic.nest=function(a){function b(a){return d3.entries(a)}function c(a){return sonic.isArray(a)&&!sonic.isArray(a[0])&&a.length>0&&(a=[a]),a.map(function(a,b){return{key:b,values:a}})}function d(){var d=[];return sonic.isNest(a)?d=a:sonic.isObject(a)?d=b(a):sonic.isArray(a)&&(d=c(a)),sonic.isSet(d)?d:[]}return d()},sonic.nest.findByKey=function(a,b){var c;return a.forEach(function(a){a.key===b&&(c=a)}),c},sonic.colors={},sonic.colors.colorMap=function(a,b){var c,d=0,e=b||d3.map(),f=a||["#EE0000","#EE5500","#DDDD00","#00CC00","#0000EE","#770077","#DD00DD","#880000","#FF3300","#CC9900","#009999","#006600","#00008F","#440044","#FF0066"];return e.values().forEach(function(a){var b=f.indexOf(a);b>=0&&(f.splice(b,1),f.push(a))}),c=function(a){return e.has(a)||(e.set(a,f[d%f.length]),d=(d+1)%f.length),e.get(a)},c.remove=function(a){var b=e.get(a),c=f.indexOf(b);f.splice(c,1),d>c&&(d-=1),f.splice(d,0,b)},c},sonic.colors.generateGradient=function(a,b,c){if(b.length!==a.length){var d=(b[1]-b[0])/(a.length-1);b=d3.range(b[0],b[1]+d,d)}return c?sonic.colors.generateDiscreteColorGradient.call(this,a,b,c):sonic.colors.generateContinuousColorGradient.call(this,a,b)},sonic.colors.generateDiscreteColorGradient=function(a,b,c){var d=d3.map(),e=d3.rgb(a.shift()),f=b.shift();return b.forEach(function(g,h){var i=(g-f)/c,j=d3.rgb(a[h]),k=(j.r-e.r)/c,l=(j.g-e.g)/c,m=(j.b-e.b)/c;d3.range(f,g+(h===b.length-1?i:0),i).forEach(function(a,b){d.set(a,d3.rgb(e.r+k*b,e.g+l*b,e.b+m*b))}),e=j,f=g}),{getColor:function(a){var b;return d.keys().some(function(c){var d=parseFloat(c);return!sonic.isSet(b)||a>d?(b=d,!1):(Math.abs(a-d)<Math.abs(a-b)&&(b=d),!0)}),d.get(b)}}},sonic.colors.generateContinuousColorGradient=function(a,b){function c(a){var c=d3.bisect(b,a);return c===b.length&&(c-=1),[c-1,c]}return{getColor:function(d){var e=c(d),f=d3.rgb(a[e[0]]),g=d3.rgb(a[e[1]]),h=g.r-f.r,i=g.g-f.g,j=g.b-f.b,k=(d-b[e[0]])/(b[e[1]]-b[e[0]]);return d3.rgb(f.r+h*k,f.g+i*k,f.b+j*k)}}},sonic.registerable=function(a,b,c){var d={},e={data:[],selection:null,config:{id:null}};return d.id=function(c){return sonic.getOrSet("id",c,b.config,a)},d.mergeConfig=function(a){sonic.object.merge(b.config,a)},d.update=function(c){var e={update:!0};sonic.isSet(c)&&(c.type!==b.config.type&&(e.from=c.type),d.mergeConfig(c)),b.selection.call(a,e)},d.remove=function(){b.selection&&b.selection.call(a,{remove:!0})},d.hasContent=function(){return b.data.length>0},sonic.object.equalize(e,b),d},sonic.listenable=function(a,b,c){var d={},e={config:{}};return d.handleEvent=function(a,c,d){var e;return"vizbodywide"===a?"mousemove"===c?e=b.onVizMouseMove?b.onVizMouseMove(d):null:"mouseout"===c?e=b.onVizMouseMove?b.onVizMouseMove():null:"click"===c&&(e=b.onVizClick?b.onVizClick(d):null):".clear-link"===a&&"click"===c&&(e=b.onVizClick?b.onVizClick():null),e},e.updateTooltips=function(d,e){var f=b.renderTooltips;b.config.tooltip&&b.config.tooltip.renderFn&&(f=b.config.tooltip.renderFn),b.config.tooltip&&(d&&e&&e.length>0?(b.config.tooltip.closestPoints=e,b.config.tooltip.content=f(e,d),b.config.tooltip.associatedId=a.id(),b.config.tooltip.mouse=d,c.showTooltip(b.config.tooltip)):c.hideTooltip(b.config.tooltip))},sonic.object.equalize(e,b),d};var ma=function(){function a(){}var b=d3.map();return a.methods=function(){return b},a.add=function(a,c){b.set(a,c)},a.remove=function(a){b.remove(a)},a}();sonic.registry=function(){function a(a){return a+"-"+Math.floor(1e4*Math.random())}function b(){}var c=d3.map(),d=[];return b.components=function(){return c},b.add=function(b,e){var f,g=sonic.isFunction(e.id)&&sonic.isSet(e.id());return c.has(b)||c.set(b,d3.map()),f=g?e.id():a(b),c.get(b).has(f)||(!g&&sonic.isFunction(e.id)&&e.id(f),c.get(b).set(f,e),sonic.array.contains(d,f)||d.push(f)),f},b.findAll=function(){return c.entries()},b.findOne=function(a,c){var d=b.find(a,c),e=null;return d[0]&&(e=d[0]),e},b.find=function(a,b){var d,e,f=[];return b=b||{},c.has(a)?(d=c.get(a),sonic.isString(b)?(e=d.get(b),sonic.isSet(e)?[d.get(b)]:[]):sonic.isSet(b.id)?sonic.isString(b.id)?(e=d.get(b.id),sonic.isSet(e)?[e]:[]):d.entries().map(function(a){return a.value}).filter(function(a){return b.id.test(a.id())}):(c.get(a).forEach(function(a,c){var d,e=!0;for(d in b)b.hasOwnProperty(d)&&(sonic.isFunction(c[d])?c[d]()!==b[d]&&(e=!1):e=!1);e&&f.push(c)}),0===f.length?[]:f)):[]},b.applyFn=function(a,b){c.forEach(function(c,d){d.forEach(function(c,d){sonic.isFunction(d[a])&&d[a].apply(d,b)})})},b.update=function(){c.has("scale")&&c.get("scale").forEach(function(a,b){b.update()}),c.forEach(function(a,b){"scale"!==a&&b.forEach(function(a,b){sonic.isFunction(b.update)&&b.update()})})},b.refresh=function(a){c.forEach(function(b,c){"scale"!==b&&c.forEach(function(b,c){b!==a&&c.update()})})},b.remove=function(a,b){var d,e=[];return c.has(a)?(d=c.get(a),sonic.isSet(b)?sonic.isString(b)&&d.has(b)?e.push(d.get(b)):sonic.isSet(b.id)&&d.has(b.id)&&e.push(d.get(b.id)):e=e.concat(d.values()),void e.forEach(function(a){a.remove(),d.remove(a.id())})):[]},b.visibleContent=function(){return d},b.registerVisibleContent=function(a,b){b?sonic.array.add(d,a.id(),!0):sonic.array.remove(d,a.id())},b},ma.add("register",a),ma.add("findAll",b),ma.add("findOne",c),ma.add("find",d),ma.add("remove",e),sonic.listener=function(a,b){function c(a){return"mousemove"===a&&e===!1}function d(){}var e,f={};return d.add=function(b){sonic.each(b,function(b,c){f[b]||(f[b]={}),sonic.each(c,function(c,d){(!sonic.isSet(d)||sonic.isFunction(d))&&(d={fn:d}),f[b][c]||(f[b][c]=[]),d.scope=d.scope||a,f[b][c].push(d)})}),d.rebind()},d.remove=function(a){sonic.isSet(a)?sonic.each(a,function(a,b){"all"===b?delete f[a]:f[a]&&b.forEach(function(b){delete f[a][b]})}):f={},d.rebind()},d.rebind=function(){var d="handleEvent";sonic.each(f,function(f,g){sonic.each(g,function(g,h){var i=a.container();"vizbodywide"!==f&&(i=i.selectAll(f)),i.on(g,function(){var j=[],k=g,l=a.mouse(i[0][0]);arguments;if("vizbodywide"===f)if(a.mouse.inBody(l))e=!1;else{if(!c(k))return;k="mouseout",e=!0}b&&b.components().forEach(function(a,b){b.forEach(function(a,b){var c,e=b[d];sonic.isFunction(e)&&(c=e.apply(b,[f,k,l]),sonic.isSet(c)&&(j=j.concat(c)))})}),h.forEach(function(a){sonic.isSet(a)&&sonic.isFunction(a.fn)&&a.fn.call(a.scope,j,l)})})})})},d},ma.add("addListeners",f),ma.add("removeListeners",g),sonic.tooltip=function(a,b){function c(a){var b;d.selection=a,d.computeData(),b=d.selection.selectAll(".sonic-tooltip").data(d.data,function(a){return a.key}),b.enter().insert("div",":first-child").classed("sonic-tooltip",!0),b.each(d.drawTooltips),b.exit().remove()}var d={tips:d3.map(),config:{position:"mouse",offset:[10,0],renderFn:null}};return c.tooltips=function(){return d.tips},c.add=function(b){d.tips.has(b.associatedId)||(d.tips.set(b.associatedId,b),d3.select(a.elId()).call(c))},c.update=sonic.override(function(b){d.tips.has(b.associatedId)&&(d.tips.set(b.associatedId,b),d3.select(a.elId()).call(c))}),c.remove=sonic.override(function(b){d.tips.has(b.associatedId)&&(d.tips.remove(b.associatedId),d3.select(a.elId()).call(c))}),c.show=function(a){a.visible=!0,d.tips.has(a.associatedId)?c.update(a):c.add(a)},c.hide=function(a){a.visible=!1,c.update(a)},d.computeData=function(){var a=[];d.data=[],d.tips.forEach(function(b,c){var e={key:b,value:c};c.visible&&("global"===c.type?a.push(e):d.data.push(e))}),a.length>0&&d.data.push({key:"global",values:a.sort(function(a,b){var c=sonic.isSet(a.value.priority)?a.value.priority:-1,d=sonic.isSet(b.value.priority)?b.value.priority:-1;return c===d?0:-1===c&&-1!==d?1:-1===d&&-1!==c?-1:d>c?-1:c>d?1:0})})},d.drawTooltips=function(a,b){var c,e=a.key,f=d3.select(this);c="global"===e?d.drawGlobalTooltip(a,f):d.drawComponentTooltip(a,f),f.style("display",function(){return c.visible?"block":"none"}),c.position.forEach(function(a,b){f.style(a,null===b?null:b+"px")}),f.html(c.html)},d.drawGlobalTooltip=function(a,b){var c,e=[],f={visible:!1,html:"",position:null};return a.values.forEach(function(a){a.value.visible&&(f.visible=!0),d.config.renderFn?e=e.concat(a.value.closestPoints):f.html+=a.value.content}),c=a.values[0].value.mouse,d.config.renderFn&&(f.html=d.config.renderFn(e,c)),"mouse"===d.config.position?f.position=d.calculateMousePosition(c):f.position=d.calculateFixedPosition(d.config.position),f},d.drawComponentTooltip=function(a,b){var c={visible:!1,html:"",position:null};return a.value.visible&&(c.visible=!0),d.config.renderFn?c.html=d.config.renderFn(a.value.closestPoints):c.html=a.value.content,"fixed"===a.value.position||sonic.isArray(a.value.position)?c.position=d.calculateFixedPosition(a.value.position,a.value.offset):c.position=d.calculateMousePosition(a.value.mouse,a.value.offset,b),c},d.calculateMousePosition=function(b,c,e){var f,g,h=d3.map(),i="left",j="top",k=a.currentPadding(),l=a.margin();return c=c||d.config.offset,f=b[0]+c[0],g=b[1]-c[1],h.set("left",null),h.set("right",null),h.set("top",null),h.set("bottom",null),b[0]>=a.body().width()/2?(i="right",f=a.body().width()-b[0]+k.right+l.right+c[0]):f=f+k.left+l.left,b[1]>=a.body().height()/2?(j="bottom",g=a.body().height()-b[1]+k.bottom+l.bottom-c[1]):g=g+k.top+l.top,h.set(i,f),h.set(j,g),h},d.calculateFixedPosition=function(b,c){var e=d3.map();return c=c||d.config.offset,sonic.isSet(b)&&"fixed"!==b||(b=["left","top"]),c=c||[0,0],isNaN(b[0])?"right"===b[0]?e.set("right",a.margin().right+c[0]):e.set("left",a.margin().left+c[0]):e.set("left",a.margin().left+b[0]),isNaN(b[1])?"bottom"===b[1]?e.set("bottom",a.margin().bottom+c[1]):e.set("top",a.margin().top+c[1]):e.set("top",a.margin().top+b[1]),e},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),c},ma.add("addTooltip",h),ma.add("removeTooltip",i),ma.add("showTooltip",j),ma.add("hideTooltip",k),sonic.svg=function(){},sonic.svg.height=function(a){return a[0][0].getBoundingClientRect().height||parseInt(a[0][0].getAttribute("height"),10)},sonic.svg.width=function(a){return a[0][0].getBoundingClientRect().width||parseInt(a[0][0].getAttribute("width"),10)},sonic.svg.hasClass=function(a,b){var c,d,e=!1;if(d=a.getAttribute("class"))for(d=d.split(" "),c=0;c<d.length;c+=1)if(d[c]===b){e=!0;break}return e},sonic.currency={},sonic.currency.format=function(a,b){var c,d=",";return b=b||{},void 0===b.decimals&&(b.decimals=2),a>=1e9?(c="B",a/=1e9):a>=1e6?(c="M",a/=1e6):a>=1e3&&(c="K",a/=1e3),void 0!==b.decimals&&(d=d+"."+b.decimals+"f"),d=d3.format(d),(b.excludeDollar?"":"$")+d(a)+(c||"")},sonic.geom={},sonic.geom.pythagorize=function(a,b){return Math.sqrt(a*a+b*b)},sonic.scale={},sonic_scale_add=function(a,b){sonic.scale[b.type](a,b)},sonic_scale_add_linear=function(a,b){sonic_scale_add(a,sonic.object.merge(b,{type:"linear"}))},sonic_scale_add_time=function(a,b){sonic_scale_add(a,sonic.object.merge(b,{type:"linear"}))},sonic_scale_add_ordinal=function(a,b){sonic_scale_add(a,sonic.object.merge(b,{type:"linear"}))},sonic_scale_update=function(a,b,c){a.find("scale",b).forEach(function(a){a.mergeConfig(c),a.update()})},sonic_scale_remove=function(a,b,c){a.remove("scale",b)},ma.add("addScale",sonic_scale_add),ma.add("addLinearScale",sonic_scale_add_linear),ma.add("addOrdinalScale",sonic_scale_add_ordinal),ma.add("addTimeScale",sonic_scale_add_time),ma.add("updateScale",sonic_scale_update),ma.add("removeScale",sonic_scale_remove),sonic.scale.linear=function(a,b){function c(){d.d3Scale=d3.scale.linear().domain(d.computeDomain()),d.d3Scale.range(d.computeRange())}var d={d3Scale:null,config:{id:null,dataKey:null,pos:null,pad:{},range:null,minDomainRange:null}};return c.update=sonic.override(function(){c()}),c.scale=function(){return d.d3Scale},c.domain=function(a,b){return sonic.isSet(a)?void(b?d.d3Scale.domain(d3.extent(d.d3Scale.domain().concat(a))):d.d3Scale.domain(a)):d.d3Scale.domain()},c.resetDomain=function(){c.domain(d.computeDomain())},c.domainMin=function(a){var b,c=a;return sonic.isSet(a)?void(sonic.isSet(d.config.min)||(d.config.pad.min&&(b=d.d3Scale.domain()[0],c=a-(d.d3Scale.domain()[1]-a)*d.config.pad.min,d.config.adjustNearZero&&0>=b*c&&(c=0)),d.d3Scale.domain([c,d.d3Scale.domain()[1]]))):d.d3Scale.domain()[0]},c.domainMax=function(a){var b,c=a;return sonic.isSet(a)?void(sonic.isSet(d.config.max)||(d.config.pad.max&&(b=d.d3Scale.domain()[1],c=a+(a-d.d3Scale.domain()[0])*d.config.pad.max,d.config.adjustNearZero&&0>=b*c&&(c=0)),d.d3Scale.domain([d.d3Scale.domain()[0],c]))):d.d3Scale.domain()[1]},c.domainExtent=function(){return d.d3Scale.domain()[1]-d.d3Scale.domain()[0]},c.domainIntervalToRange=function(a){return d.d3Scale(d.d3Scale.domain()[0]+a)},c.nearest=function(a,b){var c,e=a[d.config.dataKey];return sonic.each(b,function(a,b){var f;return f=Math.abs(b[d.config.dataKey]-e),sonic.isSet(c)||(c={}),(!sonic.isSet(c.dist)||f<c.dist)&&(c.point=b,c.dist=f,0===f)?!1:void 0}),c},c.sort=function(a){return a.sort(sonic.sortByProp(d.config.dataKey))},c.rangeInputs=function(){return d.config.range},c.resetScale=function(a){return this.range(a)},c.range=function(a){return sonic.isSet(a)?(d.config.range=a,d.d3Scale.range(d.computeRange()),c):d.d3Scale.range()},c.rangeExtent=function(){return n(c)},c.rangeMin=function(){return d3.min(d.d3Scale.range())},c.rangeMax=function(){return d3.max(d.d3Scale.range())},c.position=function(a){return d.d3Scale(a)},c.dataKey=function(){return d.config.dataKey},c.type=function(){return"linear"},d.computeDomain=function(){var b,c,e,f={};return b=l(a.data(),d.config),0===b.length?[0,1]:(b[0]===b[1]&&(c=.1*b[0]<5?5:.1*b[0],b[1]=b[1]+c),d.config.pad&&(d.config.pad.max&&(f.max=b[1],b[1]=b[1]+(b[1]-b[0])*d.config.pad.max,d.config.adjustNearZero&&f.max*b[1]<=0&&(b[1]=0)),d.config.pad.min&&(f.min=b[0],b[0]=b[0]-(b[1]-b[0])*d.config.pad.min,d.config.adjustNearZero&&f.min*b[0]<=0&&(b[0]=0))),d.config.minDomainRange&&b[1]-b[0]<d.config.minDomainRange&&(e=Math.ceil((d.config.minDomainRange-(b[1]-b[0]))/2),f.min=b[0],f.max=b[1],b[0]=b[0]-e,d.config.adjustNearZero&&f.min*b[0]<=0&&(b[0]=0,b[1]=b[1]+e),b[1]=b[1]+e,d.config.adjustNearZero&&f.max*b[1]<=0&&(b[1]=0,b[0]=b[0]-e)),b)},d.computeRange=function(){return m(a,d.config.pos,d.config.range)},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),c(),a.register("scale",c),c},sonic.scale.ordinal=function(a,b){function c(a){d.d3Scale=d3.scale.ordinal().domain(d.computeDomain()).rangeBands(d.computeRange())}var d={d3Scale:null,config:{id:null,dataKey:null,pos:null,range:null,ticks:{sort:function(a,b){return b>a?-1:a>b?1:0}}}};return c.update=sonic.override(function(){c()}),c.scale=function(){return d.d3Scale},c.resetScale=function(a){return this.rangeBands(a)},c.rangeInputs=function(){return d.config.range},c.rangeBands=function(a){return sonic.isSet(a)?(d.config.range=a,d.d3Scale.rangeBands(d.computeRange()),c):d.d3Scale.range()},c.range=c.rangeBands,c.rangeExtent=function(){return n(c)},c.rangeMin=function(){return d3.min(d.d3Scale.range())},c.rangeMax=function(){return d3.max(d.d3Scale.range())+c.rangeBand()},c.rangeBand=function(){return d.d3Scale.rangeBand()},c.domainExtent=function(){return d.d3Scale.domain().length},c.position=function(a,b){var c=d.d3Scale(a);return"center"===b||"bin"===b?c+=d.d3Scale.rangeBand()/2:"max"===b&&(c+=d.d3Scale.rangeBand()),c},c.dataKey=function(){return d.config.dataKey},c.type=function(){return"ordinal"},d.computeDomain=function(){var b,c=[];return sonic.isArray(d.config.ticks.values)?c=d.config.ticks.values:a.data().forEach(function(a){a.values.forEach(function(a,b){var e=a[d.config.dataKey];-1===c.indexOf(e)&&c.push(e)})}),"BYVALUE"===d.config.ticks.sortType?a.data().length>0&&(b=sonic.clone(a.data()).sort(d.config.ticks.sort).map(function(a){return a.values.length>0?a.values[0][d.config.dataKey]:""}),c.forEach(function(a){-1===b.indexOf(a)&&b.push(a)}),c=b.filter(function(a){return""!==a})):d.config.ticks.sort&&(c=c.sort(d.config.ticks.sort)),c},d.computeRange=function(){return m(a,d.config.pos,d.config.range)},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),c(),a.register("scale",c),c},sonic.scale.time=function(a,b){function c(){"UTC"===sonic.timezone?d.d3Scale=d3.time.scale.utc().domain(d.computeDomain()).range(d.computeRange()):d.d3Scale=d3.time.scale().domain(d.computeDomain()).range(d.computeRange())}var d={d3Scale:null,config:{id:null,dataKey:null,pos:null,range:null,bin:"day"}};return c.update=sonic.override(function(){return c()}),c.scale=function(){return d.d3Scale},c.domain=function(a,b){return sonic.isSet(a)?void(b?d.d3Scale.domain(d3.extent(d.d3Scale.domain().concat(a))):d.d3Scale.domain(a)):d.d3Scale.domain()},c.resetDomain=function(){c.domain(d.computeDomain())},c.domainIntervalToRange=function(a){return d.d3Scale(new Date(d.d3Scale.domain()[0].getTime()+a))},c.domainRangeToInterval=function(a){return d.d3Scale.invert(a).getTime()-d.d3Scale.domain()[0].getTime()},c.resetScale=function(a){return this.range(a)},c.rangeInputs=function(){return d.config.range},c.range=function(a){return sonic.isSet(a)?(d.config.range=a,d.d3Scale.range(d.computeRange()),c):d.d3Scale.range()},c.rangeExtent=function(){return n(c)},c.rangeMin=function(){return d3.min(d.d3Scale.range())},c.rangeMax=function(){return d3.max(d.d3Scale.range())},c.nearest=function(a,b){var c,e=a[d.config.dataKey];return sonic.each(b,function(a,b){var f;return f=Math.abs(b[d.config.dataKey].getTime()-e),sonic.isSet(c)||(c={}),(!sonic.isSet(c.dist)||f<c.dist)&&(c.point=b,c.dist=f,0===f)?!1:void 0}),c},c.sort=function(a){return a.sort(sonic.sortByProp(d.config.dataKey))},c.domainDistance=function(a,b){return a.getTime()-b.getTime()},c.domainExtent=function(){var a;switch(d.config.bin){case"weeks":case"week":a=c.numWeeks();break;default:a=c.numDays()}return a.length},c.numDays=function(){return d3.time.days(d.d3Scale.domain()[0],d.d3Scale.domain()[1])},c.numWeeks=function(){return d3.time.weeks(d.d3Scale.domain()[0],d.d3Scale.domain()[1])},c.position=function(a){return d.d3Scale(a)},c.invert=function(a){return d.d3Scale.invert(a)},c.dataKey=function(){return d.config.dataKey},c.type=function(){return"time"},d.computeDomain=function(){var b,c,e;return c=l(a.data(),d.config),0===c.length?[new Date(0),new Date(1e6)]:(c[0]=new Date(c[0]),c[1]=new Date(c[1]),c[0]===c[1]&&(b=36e5,e=c[0].getTime()%b,0===e?c[1]=new Date(c[1].getTime()+b):23===e?c[0]=new Date(c[1].getTime()-b):(c[0]=new Date(c[0].getTime()-b),c[1]=new Date(c[1].getTime()+b))),d.config.pad&&(d.config.pad.max&&(c[1]=new Date(c[1].getTime()+d.config.pad.max)),d.config.pad.min&&(c[0]=new Date(c[0].getTime()-d.config.pad.min))),c)},d.computeRange=function(){return m(a,d.config.pos,d.config.range)},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),c(),a.register("scale",c),c},sonic.axis=function(a,b){function c(b,e){d.selection=b,d.minPad=0,d.config.height=a.body().height(),d.config.width=a.body().width(),("left"===d.config.pos||"right"===d.config.pos)&&(d.config.orient="vert"),d.setScales(),d.config.edgeLength=d.scale.rangeExtent(),d.axe=d3.svg.axis().scale(d.scale.scale()).orient(d.config.pos),d.computePadding(),d.computeLabelPosition(),d.computeTicks(),d.drawAxis(b,e||{}),a.registerVisibleContent(c,!1)}var d={scale:null,axe:null,minPad:null,config:{pos:"bottom",range:null,orient:"horiz",cls:"x",dataKey:"x",type:"linear",pinTo:{scale:null,value:null},offset:{dx:null,dy:null},animation:null,pad:{},ticks:{showLabels:!0,count:void 0,minHorizSpacing:80,minVertSpacing:30,padding:null,formatFn:null,subdivide:null,values:null,min:null,max:null,snapTo:null,snapToScale:null,rotate:null,textAnchor:null,dx:null,dy:null,interval:null,step:null},label:{text:null,pos:"middle",rotate:null,x:null,y:null,dx:null,dy:null,padding:35}}};return c.currentPadding=function(){return a.currentPadding()},c.scale=function(){return d.scale},c.range=function(){return d.config.range},c.pos=function(){return d.config.pos},c.dataKey=function(){return d.config.dataKey},d.updatePadding=function(b){var e={};e[d.config.pos]=b,a.currentPadding(e,c.id()),d.config.height=a.body().height(),d.config.width=a.body().width()},d.checkAndSetPadding=function(b,c){var e=d.axe.tickSize(),f=d.computeTickPadding(),g=11,h=12,i=sonic.isSet(d.config.label.dy)?d.config.label.dy:0,j=sonic.isSet(d.config.label.dx)?d.config.label.dx:0,k=d.config.label.padding;"auto"===a.padding()[d.config.pos]&&"horiz"===b?c=e+f+g+i+h+10:"auto"===a.padding()[d.config.pos]&&"vert"===b&&(c=e+f+j+k+10),d.minPad=c,d.findSamePosAxis(d.config.pos,c)>a.currentPadding()[d.config.pos]&&d.updatePadding(c)},d.findSamePosAxis=function(b,c){var d,e=a.registry().find("sonic-axis");return e.forEach(function(a){a.pos()===b&&(d=a.currentPadding()[b]<c?c:a.currentPadding()[b])}),d},d.computePadding=function(){var b,c,e=a.padding()[d.config.pos];"horiz"===d.config.orient?(d.checkAndSetPadding(d.config.orient,e),sonic.isSet(d.config.range)||(b=sonic.isSet(d.config.offset.dx)?d.config.offset.dx:0,c=a.body().width(),d.scale.resetScale([b,c]))):(d.checkAndSetPadding(d.config.orient,e),sonic.isSet(d.config.range)||(b=sonic.isSet(d.config.offset.dy)?d.config.offset.dy:0,c=a.body().height(),d.scale.resetScale([b,c])))},d.computeOffset=function(){var b,c,e=d.config.offset.dx,f=d.config.offset.dy,g=!1;return sonic.isSet(e)||(e="right"===d.config.pos?d.config.width:0),sonic.isSet(f)||(f="bottom"===d.config.pos?d.config.height:0),sonic.isSet(d.config.pinTo.scale)&&(b=a.findOne("scale",{dataKey:d.config.pinTo.scale}),b&&(d.config.pinTo.value<b.domainMin()?(b.domainMin(d.config.pinTo.value),g=!0):d.config.pinTo.value>b.domainMax()&&(b.domainMax(d.config.pinTo.value),g=!0),g&&a.findOne("sonic-axis",{dataKey:d.config.pinTo.scale}).update(),c=b.position(d.config.pinTo.value),"horiz"===d.config.orient?f=c:e=c)),{x:e,y:f}},d.drawAxis=function(b,c){var e,f,g,h,i=d.computeOffset(),j=[d.config.cls,d.config.id,"major","sonic-axis"],k=[];g=d.config.animation?d.config.animation.delay:a.animation().delay,h=d.config.animation?d.config.animation.duration:a.animation().duration,
c.remove||k.push({id:1}),d.config.ticks.showMinor&&j.push("minor"),e=b.selectAll("g."+d.config.id).data(k,function(a){return a.id}),e.enter().insert("g",":first-child").classed(j.join(" "),!0).attr("transform","translate("+i.x+", "+i.y+")"),e.each(d.drawLabel),e.transition().delay(g).duration(h).attr("transform","translate("+i.x+", "+i.y+")").call(d.axe),f=e.selectAll("g.tick text").transition().delay(g).duration(h),sonic.isSet(d.config.ticks.textAnchor)&&f.style("text-anchor",d.config.ticks.textAnchor),sonic.isSet(d.config.ticks.rotate)&&f.attr("transform",function(){return"rotate("+(d.config.ticks.rotate||0)+")"}),sonic.isSet(d.config.ticks.dx)&&f.attr("dx",d.config.ticks.dx),sonic.isSet(d.config.ticks.dy)&&f.attr("dy",d.config.ticks.dy),f.each(d.insertLinebreaks),e.exit().remove()},d.computeTickSize=function(){var a=d.config.ticks.size;return d.config.ticks.showMinor&&(a="vert"===d.config.orient?[-1*d.config.width,-1*d.config.width,0]:[-1*d.config.height,-1*d.config.height,0]),a},d.computeTickCount=function(){var a,b,c=d.config.ticks.count;return"ordinal"===d.config.type?c:(a="horiz"===d.config.orient?d.config.edgeLength/d.config.ticks.minHorizSpacing:d.config.edgeLength/d.config.ticks.minVertSpacing,sonic.isSet(c)||(c=a),d.config.ticks.count>a?c=a:"linear"===d.config.type&&"integer"===d.config.ticks.snapTo?c=c>d.scale.domainExtent()*(d.config.ticks.snapToScale||1)?d.scale.domainExtent()*(d.config.ticks.snapToScale||1):c:"time"===d.config.type&&("day"===d.config.ticks.snapTo?c=d.scale.numDays().length>0&&c>d.scale.numDays().length?d.scale.numDays().length:c:"week"===d.config.ticks.snapTo&&(c=d.scale.numWeeks().length>0&&c>d.scale.numWeeks().length?d.scale.numWeeks().length:c)),"time"===d.config.type&&sonic.isSet(d.config.ticks.interval)?(b=sonic.isSet(d.config.ticks.step)?d.config.ticks.step:"day"===d.config.ticks.snapTo?Math.ceil(d.scale.numDays().length/c):Math.ceil(d.scale.numWeeks().length/c),[d.config.ticks.interval,b]):[Math.floor(c)])},d.computeTickPadding=function(){var a=3;return sonic.isSet(d.config.ticks.padding)&&(a=d.config.ticks.padding),a},d.computeTickLabels=function(){var a=d.config.ticks.formatFn;return d.config.ticks.showLabels===!1&&(a=function(){return""}),a},d.computeTicks=function(){sonic.doIfSet(function(a){d.axe.ticks.apply(this,a)},d.computeTickCount()),sonic.doIfSet(d.axe.tickPadding,d.computeTickPadding()),sonic.doIfSet(function(a){d.axe.tickSize.apply(this,a)},d.computeTickSize()),sonic.doIfSet(d.axe.tickFormat,d.computeTickLabels()),sonic.doIfSet(d.axe.tickSubdivide,d.config.ticks.subdivide),sonic.doIfSet(d.axe.tickValues,d.config.ticks.values)},d.insertLinebreaks=function(a){var b=d3.select(this),c=d3.select(this).text().split("\n");-1!==b.text().indexOf("\n")&&(b.text(""),d3.range(c.length).forEach(function(a){var d=b.append("tspan").text(c[a]);a>0&&d.attr("x",0).attr("dy","15")}))},d.setScales=function(){sonic.isSet(d.config.scale)?(d.scale=d.config.scale,d.config.scaleId=d.scale.id(),delete d.config.scale):d.config.scaleId?d.scale=a.findOne("scale",d.config.scaleId):(d.scale=a.findOne("scale",{dataKey:d.config.dataKey}),d.scale||(sonic_scale_add(a,d.config),d.scale=a.findOne("scale",{dataKey:d.config.dataKey}),d.config.scaleId=d.scale.id())),"ordinal"===d.scale.type()||!sonic.isSet(d.config.min)&&null!==d.config.min||d.scale.domain()[0]===d.config.min||(d.domainMin=d.config.min,delete d.config.min,d.scale.mergeConfig({min:d.domainMin}),d.scale.resetDomain(),a.refreshRegistry(c.id())),"ordinal"===d.scale.type()||!sonic.isSet(d.config.max)&&null!==d.config.max||d.scale.domain()[1]===d.config.max||(d.domainMax=d.config.max,delete d.config.max,d.scale.mergeConfig({max:d.domainMax}),d.scale.resetDomain(),a.refreshRegistry(c.id())),!sonic.isSet(d.config.range)||d.config.range[0]===d.scale.rangeInputs()[0]&&d.config.range[1]===d.scale.rangeInputs()[1]||(d.scale.range(d.config.range),a.refreshRegistry(c.id()))},d.drawLabel=function(a,b){var c;c=d3.select(this).selectAll("text").data([1]),c.enter().append("text"),c.classed(d.config.id+" "+d.config.cls+" sonic-label",!0).attr("transform","rotate("+(d.config.label.rotate||0)+")").attr("x",d.config.label.x).attr("y",d.config.label.y).attr("dx",d.config.label.dx).attr("dy",d.config.label.dy).style("text-anchor",d.config.label.anchor).text(d.config.label.text)},d.computeLabelPosition=function(){sonic.isSet(d.config.label.anchor)||(d.config.label.anchor="middle"),"horiz"===d.config.orient&&("bottom"===d.config.pos?d.config.label.y=a.currentPadding()[d.config.pos]-d.config.label.dy-10:d.config.label.y=-1*a.currentPadding()[d.config.pos]-d.config.label.dy+10,d.config.label.x=d.scale.rangeExtent()/2+d.config.label.dx+d.scale.rangeMin(),isNaN(d.config.label.x)&&(d.config.label.x=a.body().width()/2)),"vert"===d.config.orient&&("left"===d.config.pos?a.currentPadding().left-d.minPad===0?(d.config.label.y=-1*(a.currentPadding()[d.config.pos]-10),"auto"!==a.padding().left&&(d.config.label.y+=d.config.label.dx)):d.config.label.y=-1*(d.minPad-d.config.label.dx-10):a.currentPadding().right-d.minPad===0?(d.config.label.y=a.currentPadding()[d.config.pos]-10,"auto"!==a.padding().right&&(d.config.label.y+=d.config.label.dx)):d.config.label.y=d.minPad-10-d.config.label.dx,d.config.label.x=-1*d.scale.rangeExtent()/2+d.config.label.dy-d.scale.rangeMin(),isNaN(d.config.label.x)&&(d.config.label.x=0),d.config.label.rotate=-90)},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),a.register("sonic-axis",c),c},sonic_axis_add=function(a,b){a.body().call(sonic.axis(a,b))},sonic_axis_addX=function(a,b){b=sonic.object.merge({dataKey:"x",cls:"x"},b),a.body().call(sonic.axis(a,b))},sonic_axis_addY=function(a,b){b=sonic.object.merge({dataKey:"y",cls:"y",pos:"left"},b),a.body().call(sonic.axis(a,b))},sonic_axis_update=function(a,b,c){a.find("sonic-axis",b).forEach(function(a){a.mergeConfig(c),a.update()})},sonic_axis_updateY=function(a,b,c){a.find("sonic-axis",sonic.object.merge({dataKey:"y"},b)).forEach(function(a){a.mergeConfig(c),a.update()})},sonic_axis_remove=function(a,b,c){a.remove("sonic-axis",b)},ma.add("addAxis",sonic_axis_add),ma.add("addXAxis",sonic_axis_addX),ma.add("addYAxis",sonic_axis_addY),ma.add("updateAxis",sonic_axis_update),ma.add("updateYAxis",sonic_axis_updateY),ma.add("removeAxis",sonic_axis_remove),sonic.heatmap=function(a,b){function c(b,e){var f,g=[d.config.cls,"sonic-heatmap-set",c.id()];d.selection=b,d.computeData(e||{}),d.setScales(),d.computeColors(),f=b.selectAll(g.join(".")).data(d.data,function(a){return a.key}),f.enter().insert("g",":first-child").classed(g.join(" "),!0),f.each(d.drawHeatmap),f.exit().remove(),d.config.zoom&&d.addZoom(e),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{id:null,cls:"",x1DataKey:"x",x2DataKey:"x2",y1DataKey:"y",y2DataKey:"y2",zDataKey:"z",xScaleId:null,yScaleId:null,colorGradient:{},colorConfig:{colorRange:{defaultRange:["#FFFFFF","#F20C0C"]},valueRange:{},step:null},seriesKeys:null,seriesIndexes:null,opacity:1,interactive:!0,tooltip:{renderFn:null},zoom:!1}};return d.addZoom=function(b){a.addZoom(c.id(),{zoom:{opts:b,fn:d.zoomAction}},d.xScale,d.yScale)},d.zoomAction=function(a){c(d.selection,a)},d.computeData=function(b){d.data=[],b.remove||(d.data=sonic.clone(a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes)),d.data.forEach(function(a,b){a.index=b,a.values=a.values.filter(function(a){return d.xScale&&d.yScale&&d.config.zoom?(a[d.config.x1DataKey]<d.xScale.domain()[0]&&a[d.config.x2DataKey]>d.xScale.domain()[0]&&(a[d.config.x1DataKey]=d.xScale.domain()[0]),a[d.config.x1DataKey]<d.xScale.domain()[1]&&a[d.config.x2DataKey]>d.xScale.domain()[1]&&(a[d.config.x2DataKey]=d.xScale.domain()[1]),a[d.config.y1DataKey]<d.yScale.domain()[0]&&a[d.config.y2DataKey]>d.yScale.domain()[0]&&(a[d.config.y1DataKey]=d.yScale.domain()[0]),a[d.config.y1DataKey]<d.yScale.domain()[1]&&a[d.config.y2DataKey]>d.yScale.domain()[1]&&(a[d.config.y2DataKey]=d.yScale.domain()[1]),!(a[d.config.x1DataKey]<d.xScale.domain()[0]||a[d.config.x2DataKey]>d.xScale.domain()[1]||a[d.config.y1DataKey]<d.yScale.domain()[0]||a[d.config.y2DataKey]>d.yScale.domain()[1])):!0})}))},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.x1DataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.y1DataKey}),d.config.yScaleId=d.yScale.id())},d.computeColors=function(){d.config.colorGradient={},d.data.forEach(function(a){var b,c,e=d3.max(a.values,function(a){return a[d.config.zDataKey]}),f=d3.min(a.values,function(a){return a[d.config.zDataKey]});c=d.config.colorConfig.colorRange[a.key]?d.config.colorConfig.colorRange[a.key]:d.config.colorConfig.colorRange.defaultRange,b=d.config.colorConfig.valueRange[a.key]?d.config.colorConfig.valueRange[a.key]:d3.range(f,e+(e-f)/c.length,(e-f)/(c.length-1)),d.config.colorGradient[a.key]=sonic.colors.generateGradient(c,b,d.config.colorConfig.step)})},d.drawHeatmap=function(b,c){var e,f=b.values;e=d3.select(this).selectAll(".sonic-heattile").data(f,function(a){var b,c;return b=a.bin?a.bin:a[d.config.x1DataKey]+"_"+a[d.config.x2DataKey],c=a.bin2?a.bin2:a[d.config.y1DataKey]+"_"+a[d.config.y2DataKey],b+"_"+c}),e.enter().append("rect").classed("sonic-heattile",!0).style("stroke-width",0).attr("x",function(a){return(d.xScale.position(a[d.config.x1DataKey])+d.xScale.position(a[d.config.x2DataKey]))/2}).attr("y",function(a){return(d.yScale.position(a[d.config.y2DataKey])+d.yScale.position(a[d.config.y1DataKey]))/2}).attr("height",0).attr("width",0),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("x",function(a){return d.xScale.position(a[d.config.x1DataKey])}).attr("y",function(a){return d.yScale.position(a[d.config.y2DataKey])}).attr("width",function(a){return d.xScale.position(a[d.config.x2DataKey])-d.xScale.position(a[d.config.x1DataKey])}).attr("height",function(a){return d.yScale.position(a[d.config.y1DataKey])-d.yScale.position(a[d.config.y2DataKey])}).attr("fill",function(a){return a.color||d.config.colorGradient[b.key].getColor(a[d.config.zDataKey]).toString()}).attr("fill-opacity",function(a){return a.opacity||d.config.opacity}),e.exit().remove()},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),d.selection.selectAll(".sonic-heattile").attr("fill",function(a,c){var e;return e=d.config.interactive&&b&&b.point===a?d.config.colorGradient[b.key].getColor(a[d.config.zDataKey]).brighter().toString():b?d.config.colorGradient[b.key].getColor(a[d.config.zDataKey]).toString():d3.select(this).attr("fill")}),b},d.closestPoints=function(a){var b=a[0],c=a[1],e=null;return d.data.forEach(function(a,f){a.values.forEach(function(f){var g=Math.abs(d.xScale.position(f[d.config.x1DataKey])),h=Math.abs(d.xScale.position(f[d.config.x2DataKey])),i=Math.abs(d.yScale.position(f[d.config.y2DataKey])),j=Math.abs(d.yScale.position(f[d.config.y1DataKey]));b>=g&&h>=b&&c>=i&&j>=c&&(e={point:f,key:a.key})})}),e},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-heatmap",c),c},ma.add("addHeat",o),ma.add("updateHeat",p),sonic.point=function(a,b){function c(b,e){var f,g=[d.config.cls,"sonic-point-set",c.id()];d.selection=b,d.computeData(),d.setScales(),f=b.selectAll(g.join(".")).data(d.data,function(a){return a.key}),f.enter().append("g").classed(g.join(" "),!0),f.each(d.drawPoints),f.each(d.setupLegend),f.exit().remove(),d.config.zoom&&d.addZoom(e),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,defaultColors:sonic.colors.colorMap(),config:{id:null,cls:"",definedDataKey:"id",xDataKey:"x",yDataKey:"y",labelKey:"markerId",xScaleId:null,yScaleId:null,seriesKeys:null,seriesIndexes:null,stroke:"",strokeWidth:1,fill:"",symbol:"circle",size:64,highlightSizeScale:2,fillOpacity:1,closestPointBy:null,standardLabel:{dx:-1,dy:1,show:!1,labelGenFn:function(a){return a.id},textColor:"#000000"},highlightLabel:{dx:-3.5,dy:3.3,show:!1,textColor:"#000000",bkgrdColor:"#ffffff",labelGenFn:function(a){return a.id}},highlightPoint:!0,tooltip:{buffer:{type:"value",amount:null},renderFn:null},zoom:!1}};return d.addZoom=function(b){a.addZoom(c.id(),{zoom:{opts:b,fn:d.zoomAction}},d.xScale,d.yScale)},d.zoomAction=function(a){c(d.selection,a)},d.computeData=function(b){b=b||{},d.data=[],b.remove||(d.data=sonic.clone(a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes)),d.data.forEach(function(a,b){a.index=b,a.values=a.values.filter(function(a){return d.xScale&&d.yScale&&d.config.zoom?!(a[d.config.xDataKey]<d.xScale.domain()[0]||a[d.config.xDataKey]>d.xScale.domain()[1]||a[d.config.yDataKey]<d.yScale.domain()[0]||a[d.config.yDataKey]>d.yScale.domain()[1]):!0})}))},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.computeColor=function(a,b,c,e){return e&&a.stroke||a.color||c.color||d.defaultColors(c.index)},d.symbolGenerator=function(a){return d3.svg.symbol().type(function(a){return a.type||a.symbol||d.config.type}).size(function(b){var c=b.size||d.config.size;return d.isClosestPoint(b,a)&&(c*=d.config.highlightSizeScale),c})},d.drawPoints=function(b,e){var f,g=[],h=d.symbolGenerator();g=b.values,f=d3.select(this).selectAll(".sonic-point").data(g,function(a){return a[d.config.definedDataKey]}),f.enter().append("path").classed(c.id()+" sonic-point",!0).attr("fill-opacity",function(a){return sonic.isSet(a.fillOpacity)?a.fillOpacity:d.config.fillOpacity}).style("opacity",function(a){return sonic.isSet(a.opacity)?a.opacity:1}).attr("d",h).attr("transform",function(a){return"translate("+d.xScale.position(a[d.config.xDataKey])+","+d.yScale.position(a[d.config.yDataKey])+")"}).attr("stroke",function(a,c){return d.computeColor.call(this,a,c,b,!0)}).attr("stroke-width",function(a,b){return a.strokeWidth||d.config.strokeWidth}).attr("fill",function(a,c){return d.computeColor.call(this,a,c,b)}).attr("fill-opacity",function(a){return sonic.isSet(a.fillOpacity)?a.fillOpacity:d.config.fillOpacity}).style("opacity",function(a){return 0}),f.transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",h).attr("transform",function(a){return"translate("+d.xScale.position(a[d.config.xDataKey])+","+d.yScale.position(a[d.config.yDataKey])+")"}).attr("stroke",function(a,c){return d.computeColor.call(this,a,c,b,!0)}).attr("stroke-width",function(a,b){return a.strokeWidth||d.config.strokeWidth}).attr("fill",function(a,c){return d.computeColor.call(this,a,c,b)}).attr("fill-opacity",function(a){return sonic.isSet(a.fillOpacity)?a.fillOpacity:d.config.fillOpacity}).style("opacity",function(a){return sonic.isSet(a.opacity)?a.opacity:1}),d.config.highlightPoint&&f.sort(function(a,b){return a.selected&&!b.selected?1:!a.selected&&b.selected?-1:0}),f.exit().transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",h).attr("transform",function(a){return"translate("+d.xScale.position(a[d.config.xDataKey])+","+d.yScale.position(a[d.config.yDataKey])+")"}).style("opacity",function(a){return 0}).remove(),d.drawLabel.call(this,g.filter(function(a){return a[d.config.labelKey]}).map(function(a){return{point:a}}),"highlightLabel")},d.setupLegend=function(a,b,d){d3.select(this).selectAll("path").attr(c.id()+"-data-legend",function(){return a.name||a.key})},d.drawLabel=function(b,e){var f;f=d3.select(this).selectAll(".symLabel").data(b,function(a){return a.point[d.config.definedDataKey]}),f.enter().append("text").classed(c.id()+" symLabel",!0).attr("transform",function(a){return"translate("+d.xScale.position(a.point[d.config.xDataKey])+","+d.yScale.position(a.point[d.config.yDataKey])+")"}).attr("dx",function(a){return sonic.isSet(a.point.dx)?a.point.dx:d.config[e].dx*a.point.markerId.toString().length}).attr("dy",function(a){return sonic.isSet(a.point.dy)?a.point.dy:d.config[e].dy}).text(function(a){return d.config[e].labelGenFn(a.point)}).style("fill",function(a){return d.config[e].textColor}).attr("font-size",function(a){return a.point.fontSize}).attr("text-anchor",function(a){return a.point.textAnchor}),f.transition().delay(a.animation().delay).duration(a.animation().duration).attr("transform",function(a){return"translate("+d.xScale.position(a.point[d.config.xDataKey])+","+d.yScale.position(a.point[d.config.yDataKey])+")"}).attr("dx",function(a){return sonic.isSet(a.point.dx)?a.point.dx:d.config[e].dx*a.point.markerId.toString().length}).attr("dy",function(a){return sonic.isSet(a.point.dy)?a.point.dy:d.config[e].dy}).text(function(a){return d.config[e].labelGenFn(a.point)}).style("fill",function(a){return d.config[e].textColor}).attr("font-size",function(a){return a.point.fontSize}).attr("text-anchor",function(a){return a.point.textAnchor}),f.exit().remove()},d.onVizMouseMove=function(a){var b,e,f;return a&&(b=d.closestPoints(a)),f=d.symbolGenerator(b),d.updateTooltips(a,b),e=d3.selectAll("."+c.id()+".sonic-point-set").selectAll("."+c.id()+" .sonic-point"),d.config.highlightPoint&&e.sort(function(a,c){return d.isClosestPoint(a,b)?1:d.isClosestPoint(c,b)?-1:0}),e.attr("fill",function(a,c){var e,f=d3.select(this.parentElement).data()[0];return e=d.computeColor.call(this,a,c,f),d.isClosestPoint(a,b)&&(d.config.highlightLabel.show?e=d.config.highlightLabel.bkgrdColor:d.config.highlightPoint&&(e=d3.rgb(e).brighter().brighter().toString())),e}).attr("d",f),d.config.highlightLabel.show&&(b?e.forEach(function(a,c){d.drawLabel.call(a.parentNode,[b[c]],"highlightLabel")},this):d3.selectAll(".symLabel").remove()),b},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),d.selection.selectAll(".sonic-point").classed("selected",function(a,c){return d.isClosestPoint(a,b)}),b},d.closestPoints=function(a){var b,c,e,f=a[0],g=a[1];if(sonic.isSet(d.config.tooltip)&&sonic.isSet(d.config.tooltip.buffer)&&sonic.isSet(d.config.tooltip.buffer.value)===!0){if(c=g>=d.yScale.rangeMin()&&g<=d.yScale.rangeMax(),c===!1)return[]}else e=!0;return c||e?(b=d.data.map(function(a){return{key:a.key,dist:null,point:null}}),d.data.forEach(function(a,c){a.values.forEach(function(a){var e,h,i;h=Math.abs(d.xScale.position(a[d.config.xDataKey],"center")-f),i=Math.abs(d.yScale.position(a[d.config.yDataKey],"center")-g),e="x"===d.config.closestPointBy?h:"y"===d.config.closestPointBy?i:sonic.geom.pythagorize(h,i),(!b[c].point||e<b[c].dist)&&d.pointWithinBuffer(a,e)&&(b[c].point=a,b[c].dist=e)})}),b=b.filter(function(a){return sonic.isSet(a.point)?!0:!1})):void 0},d.isClosestPoint=function(a,b){return sonic.isArray(b)?b.filter(function(b){return b.point[d.config.definedDataKey]===a[d.config.definedDataKey]}).length>0:!1},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(d.config.tooltip.associatedId=c.id(),b?e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.removeTooltip(d.config.tooltip):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+":</b>"+b.point[d.config.yDataKey],c+"</p>"}).reduce(function(a,b){return a+b})},d.pointWithinBuffer=function(a,b){var c=!0,e=Math.sqrt(a.size||d.config.size)/2;return sonic.isSet(d.config.tooltip)&&sonic.isSet(d.config.tooltip.buffer)&&sonic.isSet(d.config.tooltip.buffer.amount)?"value"===d.config.tooltip.buffer.type?d.xScale.domainRangeToInterval(b)>d.config.tooltip.buffer.amount&&(c=!1):b>d.config.tooltip.buffer.amount&&(c=!1):sonic.isSet(d.config.tooltip)&&sonic.isSet(d.config.tooltip.buffer)&&"radius"===d.config.tooltip.buffer.type&&b>e&&(c=!1),c},c.updatePoint=function(b){var c,e=d.selection.selectAll(".sonic-point").filter(function(a){return a.id===b.id}),f=d.symbolGenerator();e.data().forEach(function(a){sonic.object.merge(a,b)}),a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes).forEach(function(a){c=a,a.values.filter(function(a){return a.id===b.id}).forEach(function(a){sonic.object.merge(a,b)})}),e.attr("d",f).transition().delay(a.animation().delay).duration(a.animation().duration).attr("transform",function(a){return"translate("+d.xScale.position(a[d.config.xDataKey])+","+d.yScale.position(a[d.config.yDataKey])+")"}).attr("stroke",function(a,b){return d.computeColor.call(this,a,b,c,!0)}).attr("stroke-width",function(a,b){return a.strokeWidth||d.config.strokeWidth}).attr("fill",function(a,b){return d.computeColor.call(this,a,b,c)}).attr("fill-opacity",function(a){return sonic.isSet(a.fillOpacity)?a.fillOpacity:d.config.fillOpacity}).style("opacity",function(a){return sonic.isSet(a.opacity)?a.opacity:1})},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-point",c),c},ma.add("addPoint",q),ma.add("addPoints",q),ma.add("updatePoint",s),ma.add("updatePoints",s),ma.add("removePoint",r),ma.add("removePoints",r),ma.add("updateSinglePoint",t),sonic.network=function(a,b){function c(b,e){var f;[d.config.cls,"sonic-network"];d.selection=b,d.setupNetworkLayout(),d.computeData(e||{}),f=d.selection.selectAll(".sonic-network."+c.id()).data([1]),f.enter().append("g").classed("sonic-network "+c.id(),!0),f.each(d.drawNetwork),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={network:d3.layout.force(),nodeToLinkMap:{},colorGradient:null,config:{type:"sonic-network",cls:"",nodeIdKey:"id",nodeDisplayKey:"name",nodeGroupKey:"group",nodeCircleRadiusKey:"radius",nodeFillKey:"fill",nodeImageKey:"image",nodeImageHighlightKey:"highlightImage",nodeImageWidthKey:"width",nodeImageHeightKey:"height",layoutOpts:{size:[.8*a.body().height(),.8*a.body().width()]},linkStyle:{opacity:1,strokeWidth:2,highlightStrokeWidthGrowth:2,highlightStrokeColor:"#CCCCCC",stroke:"#CCCCCC",showDirections:!0,gradient:null},nodeStyle:{opacity:.7,strokeWidth:2,colorBy:"depth",nodeColors:sonic.colors.colorMap(),radius:5,highlightRadiusGrowth:3,label:{fill:"#555",fontFamiy:"arial",fontSize:"12px",anchor:"middle"},range:null,isDraggable:!0},tooltip:{buffer:{type:"value",amount:null}},networkForce:{gravity:.05,distance:100,charge:-100}}};return c.hasContent=sonic.override(function(){return d.data.nodes&&d.data.nodes.length>0}),d.setupNetworkLayout=function(){var a=d.calcLayoutSize();d.network.size(a)},d.calcLayoutSize=function(){var a=d.config.layoutOpts.size;return a=b&&b.layoutOpts&&b.layoutOpts.size?b.layoutOpts.size:d.calcLayoutLinear()},d.calcLayoutLinear=function(){return[d.calcHeight(),d.calcWidth()]},d.calcWidth=function(){return.8*a.body().width()},d.calcHeight=function(){return.8*a.body().height()},d.computeData=function(b){var c,e,f=a.data()[0].values,g=null,h=null,i=d.selection.selectAll(".node");d.colorGradient=null,d.nodeToLinkMap={},d.data={nodes:[],links:[]},b.remove||(a.data()[0]&&a.data()[0].values&&(d.data.nodes=a.data()[0].values),a.data()[1]&&a.data()[1].values&&(d.data.links=a.data()[1].values,d.data.links.forEach(function(a){for(c=0;c<d.data.nodes.length;c++)d.data.nodes[c][d.config.nodeIdKey]===a.source&&(a.source=d.data.nodes[c]);for(e=0;e<d.data.nodes.length;e++)d.data.nodes[e][d.config.nodeIdKey]===a.target&&(a.target=d.data.nodes[e]);d.nodeToLinkMap[a.source[d.config.nodeIdKey]]||(d.nodeToLinkMap[a.source[d.config.nodeIdKey]]=[]),d.nodeToLinkMap[a.target[d.config.nodeIdKey]]||(d.nodeToLinkMap[a.target[d.config.nodeIdKey]]=[]),d.nodeToLinkMap[a.source[d.config.nodeIdKey]].push(a),d.nodeToLinkMap[a.target[d.config.nodeIdKey]].push(a),(!sonic.isSet(g)||a.weight>g)&&(g=a.weight),(!sonic.isSet(h)||a.weight<h)&&(h=a.weight)})),d.data.nodes.forEach(function(a){a.links=d.nodeToLinkMap[a[d.config.nodeIdKey]],d.config.persistMove&&d.persistMove(a,i)}),sonic.isSet(d.config.linkStyle.gradient)&&(0>h*g?d.colorGradient=sonic.colors.generateGradient(d.config.linkStyle.gradient,[h,0,g]):d.colorGradient=sonic.colors.generateGradient(d.config.linkStyle.gradient,[h,g])),d.config.nodeStyle.range&&(d.dataMin=d3.min(f,function(a){return a[d.config.nodeCircleRadiusKey]}),d.dataMax=d3.max(f,function(a){return a[d.config.nodeCircleRadiusKey]})))},d.persistMove=function(a,b){b.each(function(b){a[d.config.nodeIdKey]===b[d.config.nodeIdKey]&&b.moved===!0&&(a.x=a.pinX||b.x,a.y=a.pinY||b.y,a.moved=!a.pinX,a.fixed=!a.pinY)})},d.drawNetwork=function(){var b,c;d.network.gravity(d.config.networkForce.gravity).distance(d.config.networkForce.distance).charge(d.config.networkForce.charge).size([d.calcWidth(),d.calcHeight()]).nodes(d.data.nodes).links(d.data.links).start(),b=d.addLinks.apply(this),c=d.addNodes.apply(this),d.network.on("tick",function(){c.attr("transform",function(b){return sonic.isSet(b.locationOffset)&&!b.moved&&(b.x=a.body().width()/2+a.body().width()/2*b.locationOffset.x,b.y=a.body().height()/2+a.body().height()/2*b.locationOffset.y),sonic.isSet(b.pinX)&&!b.moved&&(b.x=b.pinX),sonic.isSet(b.pinY)&&!b.moved&&(b.y=b.pinY),b.x<0?b.x=0:b.x>a.body().width()&&(b.x=a.body().width()),b.y<0?b.y=0:b.y>a.body().height()&&(b.y=a.body().height()),"translate("+b.x+","+b.y+")"}),b.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})})},d.addLinks=function(){var a,b;return d3.select(this).append("g").attr("id","links"),a=d3.select(this).select("#links").selectAll(".link").data(d.network.links(),function(a){return a.source[d.config.nodeIdKey]+"_"+a.target[d.config.nodeIdKey]}),b=a.enter().append("line").classed("link",!0),a.style("stroke",function(a){return sonic.isSet(d.colorGradient)?d.colorGradient.getColor(a.weight).toString():a.stroke||a.color||d.config.linkStyle.stroke}).style("stroke-width",function(a){return d.config.linkStyle.strokeWidth}),a.exit().remove(),a},d.addNodes=function(){var a,b,c;return d.config.nodeStyle.isDraggable&&(c=d.network.drag().on("dragstart",d.dragstart)),a=d3.select(this).selectAll(".node").data(d.data.nodes,function(a){return isNaN(Number(a[d.config.nodeIdKey]))?a[d.config.nodeIdKey]:parseInt(a[d.config.nodeIdKey],10)}),b=a.enter().append("g").classed("node",!0).classed("fixed",function(a){return sonic.isSet(a.locationOffset)||sonic.isSet(a.pinX)&&sonic.isSet(a.pinY)?(a.fixed=!0,!0):!1}),d.config.nodeStyle.isDraggable&&a.call(c),b.append("circle"),a.selectAll("g circle").attr("r",function(a){var b=d.calcNodeSize(a);return b.height&&b.width?0:b}).style("fill",function(a){return d.getNodeColor.call(this,a)}).style("fill-opacity",d.config.nodeStyle.opacity).style("stroke",function(a){return d3.rgb(d.getNodeColor.call(this,a)).darker()}).style("stroke-width",d.config.nodeStyle.strokeWidth),b.append("image"),a.selectAll("g image").attr("xlink:href",function(a){return d.getNodeImage.apply(this,arguments)}).attr("y",function(a){var b=d.calcNodeSize(a);return b.height?-1*b.height/2:-10}).attr("x",function(a){var b=d.calcNodeSize(a);return b.width?-1*b.width/2:-10}).attr("width",function(a){var b=d.calcNodeSize(a);return b.width?b.width:16}).attr("height",function(a){var b=d.calcNodeSize(a);return b.height?b.height:16}),d.config.nodeStyle.label&&(b.append("text"),a.selectAll("g text").attr("dx",function(a){return d.config.nodeStyle.label.dx||0}).attr("dy",function(a){if(d.config.nodeStyle.label.dy)return d.config.nodeStyle.label.dy;var b=d.calcNodeSize(a);return b.height&&b.width?-1*b.height/2-5:-1*b-5}).style("fill",d.config.nodeStyle.label.fill).style("stroke","none").style("font-size",d.config.nodeStyle.label.fontSize).style("font-family",d.config.nodeStyle.label.fontFamily).style("font-weight",d.config.nodeStyle.label.fontWeight).style("text-anchor",d.config.nodeStyle.label.anchor).text(function(a){return a[d.config.nodeDisplayKey]})),a.exit().remove(),a},d.dragstart=function(a){a.fixed=!0,a.moved=!0,d3.select(this).classed("fixed",!0)},d.dragstop=function(a){a.dragging=!1},d.calcNodeSize=function(a){if(a&&a[d.config.nodeImageKey]&&sonic.isSet(a[d.config.nodeImageHeightKey])&&sonic.isSet(a[d.config.nodeImageWidthKey]))return{height:a[d.config.nodeImageHeightKey],width:a[d.config.nodeImageWidthKey]};if(a&&sonic.isSet(a[d.config.nodeCircleRadiusKey])){var b,c=d.config.nodeStyle.range;return c?(b=(a[d.config.nodeCircleRadiusKey]-d.dataMin)/(d.dataMax-d.dataMin),(c[1]-c[0])*b+c[0]):a[d.config.nodeCircleRadiusKey]}return d.config.nodeStyle.radius},d.getNodeColor=function(a,b){var c=a.color;return c||(c="depth"===d.config.nodeStyle.colorBy?d.config.nodeStyle.nodeColors(a.depth):d.config.nodeStyle.nodeColors(a[d.config.nodeGroupKey])),sonic.svg.hasClass(this,"selected")&&(c=d3.rgb(c).darker().toString()),c},d.getNodeImage=function(a,b){var c;return a[d.config.nodeImageKey]&&(c=a[d.config.nodeImageKey]),sonic.svg.hasClass(this,"selected")&&a[d.config.nodeImageHighlightKey]&&(c=a[d.config.nodeImageHighlightKey]),c},d.closestPoints=function(a){var b,c=d.getClosestPoints(d.data,a);if(b=d.calcNodeSize(c[0]),b.height&&b.width){if(c[1]<Math.max(b.height,b.width))return c}else if(c[1]<b)return c;return[]},d.isClosestPoint=function(a,b){var c=!1;return b&&b.forEach(function(b){b&&b[d.config.nodeIdKey]===a[d.config.nodeIdKey]&&(c=!0)}),c},d.getClosestPoints=function(a,b){var c=[null,null];return a.nodes&&a.nodes.forEach(function(a){var d=Math.sqrt(Math.pow(b[0]-a.x,2)+Math.pow(b[1]-a.y,2));(!c[1]||d<c[1])&&(c=[a,d])}),c},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),d.selection.selectAll(".sonic-network."+c.id()+" g circle").classed("selected",function(a,c){return d.isClosestPoint(a,b)}).style("fill",function(a){return d.getNodeColor.apply(this,arguments)}).style("stroke",function(a){return d3.rgb(d.getNodeColor.apply(this,arguments)).darker()}),d.selection.selectAll(".sonic-network."+c.id()+" g image").classed("selected",function(a,c){return d.isClosestPoint(a,b)}).attr("xlink:href",function(a){return d.getNodeImage.apply(this,arguments)}),b},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),d.selection.selectAll(".sonic-network."+c.id()+" g circle:not(.selected)").style("fill",function(a){var c=d.getNodeColor.apply(this,arguments);return d.isClosestPoint(a,b)?d3.rgb(c).brighter():c}).style("stroke",function(a){var c=d.getNodeColor.apply(this,arguments);return c=d3.rgb(c).darker(),d.isClosestPoint(a,b)?d3.rgb(c).brighter():c}),d.selection.selectAll(".sonic-network."+c.id()+" g image:not(.selected)").attr("xlink:href",function(a){return d.isClosestPoint(a,b)&&a[d.config.nodeImageHighlightKey]?a[d.config.nodeImageHighlightKey]:d.getNodeImage.apply(this,arguments)}),d.selection.selectAll(".sonic-network."+c.id()+" line").style("stroke-width",function(a){var c=d.config.linkStyle.strokeWidth;return b&&b.length>0&&b[0][d.config.nodeIdKey]===a.source[d.config.nodeIdKey]||b&&b.length>0&&b[0][d.config.nodeIdKey]===a.target[d.config.nodeIdKey]?c+d.config.linkStyle.highlightStrokeWidthGrowth:c}).style("stroke",function(a){return b&&b.length>0&&b[0][d.config.nodeIdKey]===a.source[d.config.nodeIdKey]||b&&b.length>0&&b[0][d.config.nodeIdKey]===a.target[d.config.nodeIdKey]?d.config.linkStyle.highlightStrokeColor:sonic.isSet(d.colorGradient)?d.colorGradient.getColor(a.weight).toString():a.stroke||a.color||d.config.linkStyle.stroke;
}),b},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.config.tooltip.renderFn=function(a){var b,c=null;return a.length>0&&(b=a[0][d.config.nodeDisplayKey],c="<b>"+b+"</b>"),c},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-network",c),c},ma.add("addNetwork",u),ma.add("updateNetwork",w),ma.add("removeNetwork",v),sonic.tree=function(a,b){function c(a,b){var e;[d.config.cls,"sonic-network"];d.selection=a,d.setupTreeLayout(),d.computeData(b||{}),e=d.selection.selectAll(".sonic-tree."+c.id()).data([1]),e.enter().append("g").classed("sonic-tree "+c.id(),!0),e.each(d.drawTree),e.exit().remove()}var d={tree:d3.layout.tree(),config:{type:"sonic-tree",cls:"",nodeIdKey:"id",nodeDisplayKey:"name",nodeGroupKey:"group",nodeSizeKey:"radius",nodeFillKey:"fill",childrenKey:"children",verticalTree:!0,collapsible:!1,layoutOpts:{size:[.8*a.body().height(),.8*a.body().width()],separation:function(a,b){return(a.parent===b.parent?1:2)/a.depth},linkPathGenerator:d3.svg.diagonal().projection(function(a){return d.config.verticalTree?[a.x,a.y]:[a.y,a.x]})},linkStyle:{opacity:1,strokeWidth:2,highlightStrokeWidthGrowth:2,stroke:"#CCCCCC",highlightStrokeChange:"darker",showDirections:!0},nodeStyle:{opacity:.7,strokeWidth:2,colorBy:"depth",nodeColors:d3.scale.category20(),radius:5,highlightRadiusGrowth:3,highlightStrokeChange:"brighter",highlightFillChange:"brighter",collapsedFillColor:"#fff",labelNode:!1,label:{fill:"#555",fontFamiy:"arial",fontSize:"12px",anchor:"middle"}},tooltip:{buffer:{type:"value",amount:null}}}};return d.setupTreeLayout=function(){var a=d.calcLayoutSize();d.tree.size(a)},d.calcLayoutSize=function(){var a=d.config.layoutOpts.size;return a=b&&b.layoutOpts&&b.layoutOpts.size?b.layoutOpts.size:d.calcLayoutLinear()},d.calcLayoutLinear=function(){return[.8*a.body().height(),.8*a.body().width()]},d.computeData=function(b){b.remove&&(d.data={}),d.data=a.data()[0].values[0]},d.drawTree=function(){var a,b;a=d.config.verticalTree?d.tree.nodes(d.data):d.tree.nodes(d.data).reverse(),b=d.tree.links(a),d.drawNode.call(this,a,d.data),d.drawLink.call(this,b,d.data)},d.drawLink=function(b,c){var e=d3.select(this).selectAll("path.link").data(b,function(a){return a.target.id});e.enter().insert("path","g").attr("class","link").attr("d",function(a){var b={x:c.x0,y:c.y0};return d.config.layoutOpts.linkPathGenerator({source:b,target:b})}).style("stroke",function(a){return a.color||d.config.linkStyle.stroke}).style("stroke-width",function(a){return d.config.linkStyle.strokeWidth}).style("fill","none"),e.transition().duration(a.animation().duration).attr("d",d.config.layoutOpts.linkPathGenerator),e.exit().transition().duration(a.animation().duration).attr("d",function(a){var b={x:c.x,y:c.y};return d.config.layoutOpts.linkPathGenerator({source:b,target:b})}).remove()},d.drawNode=function(b,c){var e,f,g,h;e=d3.select(this).selectAll("g.node").data(b,function(a){return a[d.config.nodeIdKey]}),f=e.enter().append("g").attr("class","node").attr("transform",function(a){return d.config.verticalTree?"translate("+c.x0+","+c.y0+")":"translate("+c.y0+","+c.x0+")"}).on("dblclick",d.onNodeDoubleClicked),f.append("circle").style("stroke",function(a){return"#fff"}).style("stroke-width",d.config.nodeStyle.strokeWidth).style("fill-opacity",d.config.nodeStyle.opacity).attr("r",1e-6),f.append("text").attr("dy","4px").attr("dx",function(a){var b=d.getNodeRadius(a);return b+3+"px"}).attr("text-anchor",function(a){return"start"}).style("fill-opacity",1e-6).style("font","4px sans-serif").text(function(a){return a[d.config.nodeDisplayKey]||""}),g=e.transition().duration(a.animation().duration).attr("transform",function(a){return d.config.verticalTree?"translate("+a.x+","+a.y+")":"translate("+a.y+","+a.x+")"}),g.select("circle").attr("r",function(a){return d.getNodeRadius(a)}).style("stroke",function(a){var b=d.getNodeColor.apply(this,arguments);return d3.rgb(b).darker()}).style("fill",function(a){var b=d.getNodeColor.apply(this,arguments);return d.config.collapsible&&a._children&&(b=d.config.nodeStyle.collapsedFillColor),b}),g.select("text").style("fill-opacity",1).style("font","10px sans-serif"),h=e.exit().transition().duration(a.animation().duration).attr("transform",function(a){return d.config.verticalTree?"translate("+c.x+","+c.y+")":"translate("+c.y+","+c.x+")"}).remove(),h.select("circle").attr("r",1e-6),h.select("text").style("fill-opacity",1e-6),b.forEach(function(a){a.x0=a.x,a.y0=a.y})},d.getNodeRadius=function(a){var b;return b=a[d.config.nodeSizeKey]?a[d.config.nodeSizeKey]:d.config.nodeStyle.radius},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),a&&(d.selection.selectAll(".sonic-tree."+c.id()+" circle:not(.selected)").style("fill",function(a){var c=d.getNodeColor.apply(this,arguments);return d.config.collapsible&&a._children&&(c=d.config.nodeStyle.collapsedFillColor),d.isClosestPoint(a,b)?d3.rgb(c).brighter():c}).style("stroke",function(a){var c=d.getNodeColor.apply(this,arguments);return c=d3.rgb(c).darker(),d.isClosestPoint(a,b)?d3.rgb(c).brighter():c}).attr("r",function(a){var c=d.getNodeRadius(a);return d.isClosestPoint(a,b)?c+d.config.nodeStyle.highlightRadiusGrowth:c}),d.selection.selectAll(".sonic-tree."+c.id()+" path").style("stroke-width",function(a){var c=d.config.linkStyle.strokeWidth;return b.length>0&&b[0][d.config.nodeIdKey]===a.source[d.config.nodeIdKey]||b.length>0&&b[0][d.config.nodeIdKey]===a.target[d.config.nodeIdKey]?c+d.config.linkStyle.highlightStrokeWidthGrowth:c})),b},d.getNodeColor=function(a,b){var c=a.color;return c||(c="depth"===d.config.nodeStyle.colorBy?d.config.nodeStyle.nodeColors(a.depth):d.config.nodeStyle.nodeColors(a.group)),sonic.svg.hasClass(this,"selected")&&(c=d3.rgb(c).darker().toString()),c},d.closestPoints=function(a){var b,c=d.getClosestPoints(d.data,a);return b=d.getNodeRadius(c[0]),c[1]<b?c:[]},d.isClosestPoint=function(a,b){var c=!1;return b.forEach(function(b){b&&b[d.config.nodeIdKey]===a[d.config.nodeIdKey]&&(c=!0)}),c},d.getClosestPoints=function(a,b){var c,e;return c=d.config.verticalTree?Math.sqrt(Math.pow(b[0]-a.x,2)+Math.pow(b[1]-a.y,2)):Math.sqrt(Math.pow(b[0]-a.y,2)+Math.pow(b[1]-a.x,2)),e=[a,c],a.children&&a.children.forEach(function(a){var c=d.getClosestPoints(a,b);c[1]<e[1]&&(e=c)}),e},d.onNodeDoubleClicked=function(b){d.config.collapsible&&b&&(b.children?(b._children=b.children,b.children=null):(b.children=b._children,b._children=null),a.update())},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),d.selection.selectAll(".sonic-tree."+c.id()+" circle").classed("selected",function(a,c){return d.isClosestPoint(a,b)}).style("fill",function(a){var b=d.getNodeColor.apply(this,arguments);return d.config.collapsible&&a._children&&(b=d.config.nodeStyle.collapsedFillColor),b}).style("stroke",function(a){return d3.rgb(d.getNodeColor.apply(this,arguments)).darker()}),b},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.config.tooltip.renderFn=function(a){var b,c,d="";return b=a[0].name,c=a[0].children||[],d="<p><b>"+b+":</b><br/><b>Children:</b><br/>",c.forEach(function(a){b=a.name,d=d+"<b>"+b+"</b><br/>"}),d},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-tree",c),c},ma.add("addTree",x),ma.add("updateTree",z),ma.add("removeTree",y),sonic.boxAndWhisker=function(a,b){function c(a,b){var e;[d.config.cls,"line"];d.selection=a,d.computeData(b||{}),d.setScales(),e=a.selectAll(".sonic-box-and-whisker."+c.id()).data([d.data]),e.enter().append("g").classed("sonic-box-and-whisker "+c.id(),!0),e.each(d.drawBox),e.each(d.drawMedian),e.each(d.drawWhiskers),e.each(d.drawCurrentPoint),e.exit().remove()}var d={xScale:null,yScale:null,config:{id:null,cls:"",xScaleId:null,yScaleId:null,seriesKeys:null,seriesIndexes:null,valueKey:"value",currentPoint:{val:null},boxStyle:{fill:"#FA8E46",stroke:"#FA8E46",strokeWidth:2,fillOpacity:.6},whiskerStyle:{stroke:"#FA8E46",strokeWidth:1},medianStyle:{stroke:"#E00707",strokeWidth:2},currentPointStyle:{fill:"#3DDDF2",fillOpacity:.8,stroke:"#3DDDF2",strokeWidth:2,type:"diamond",size:50},sortFn:function(a,b){return b>a?-1:a>b?1:0},tooltip:{type:"global",renderFn:function(a,b){return"<p><b>Min Outlier: </b>"+a[0].min+"<br/><b>1st Quartile: </b>"+a[0].q1+"<br/><b>Median: </b>"+a[0].q2+"<br/><b>3rd Quartile: </b>"+a[0].q3+"<br/><b>Max Outlier: </b>"+a[0].max+"<br/><b>Current Point: </b>"+d.config.currentPoint.val+"<br/></p>"}}}};return d.computeData=function(b){var c=[];d.data=[],b.remove||(a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes).filter(function(a,b){return a.values.length>0?!0:void 0}).forEach(function(a){c=c.concat(a.values)}),c=c.map(function(a){return sonic.isSet(a[d.config.valueKey])?a[d.config.valueKey]:a}),c.sort(d.config.sortFn),d.computeQuartilesAndExtrema(c))},d.computeQuartilesAndExtrema=function(a){var b,c;d.data={min:null,max:null,q1:null,q2:null,q3:null},d.data.min=a[0],d.data.max=a[a.length-1],a.length%2===0?(d.data.q2=(a[a.length/2]+a[a.length/2-1])/2,b=a.slice(0,a.length/2),c=a.slice(a.length/2,a.length)):(d.data.q2=a[Math.floor(a.length/2)],b=a.slice(0,Math.floor(a.length/2)),c=a.slice(Math.ceil(a.length/2),a.length)),b%2===0?d.data.q1=(b[b.length/2]+b[b.length/2-1])/2:d.data.q1=b[Math.floor(b.length/2)],c%2===0?d.data.q3=(c[c.length/2]+c[c.length/2-1])/2:d.data.q3=c[Math.floor(c.length/2)]},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.drawBox=function(){var b=d3.select(this).selectAll("rect").data([d.data]);b.enter().append("rect"),b.transition().duration(a.animation().duration).delay(a.animation().delay).style("stroke-width",d.config.boxStyle.strokeWidth).style("stroke",d.config.boxStyle.stroke).style("fill",d.config.boxStyle.fill).style("fill-opacity",d.config.boxStyle.fillOpacity).attr("x",d.xScale.position(d.data.q1)).attr("y",d.yScale.position(1)).attr("height",d.yScale.position(0)-d.yScale.position(1)).attr("width",d.xScale.position(d.data.q3)-d.xScale.position(d.data.q1)),b.exit().remove()},d.drawMedian=function(){var b=d3.select(this).selectAll("line.median").data([d.data]);b.enter().append("line").classed("median",!0),b.transition().duration(a.animation().duration).delay(a.animation().delay).style("stroke",d.config.medianStyle.stroke).style("stroke-width",d.config.medianStyle.strokeWidth).attr("x1",d.xScale.position(d.data.q2)).attr("y1",d.yScale.position(0)).attr("x2",d.xScale.position(d.data.q2)).attr("y2",d.yScale.position(1)),b.exit().remove()},d.drawWhiskers=function(){var b,c,e=d3.select(this).selectAll("g.whiskers").data([d.data]);e.enter().append("g").classed("whiskers",!0),b=e.selectAll("line.left-whisker").data([d.data]),b.enter().append("line").classed("left-whisker",!0),c=e.selectAll("line.right-whisker").data([d.data]),c.enter().append("line").classed("right-whisker",!0),b.transition().duration(a.animation().duration).delay(a.animation().delay).style("stroke",d.config.whiskerStyle.stroke).style("stroke-width",d.config.whiskerStyle.strokeWidth).attr("x1",d.xScale.position(d.data.min)).attr("y1",d.yScale.position(.5)).attr("x2",d.xScale.position(d.data.q1)).attr("y2",d.yScale.position(.5)),c.transition().duration(a.animation().duration).delay(a.animation().delay).style("stroke",d.config.whiskerStyle.stroke).style("stroke-width",d.config.whiskerStyle.strokeWidth).attr("x1",d.xScale.position(d.data.q3)).attr("y1",d.yScale.position(.5)).attr("x2",d.xScale.position(d.data.max)).attr("y2",d.yScale.position(.5)),b.exit().remove(),c.exit().remove(),e.exit().remove()},d.symbolGenerator=function(a){return d3.svg.symbol().type(function(a){return a.type||a.symbol||d.config.currentPointStyle.type}).size(function(a){var b=a.size||d.config.currentPointStyle.size;return b})},d.drawCurrentPoint=function(){var b=d3.select(this).selectAll("path.currentPoint").data([d.config.currentPointStyle]);b.enter().append("path").classed("currentPoint",!0).attr("d","M0,0"),b.transition().duration(a.animation().duration).delay(a.animation().delay).attr("transform","translate("+d.xScale.position(d.config.currentPoint.val)+","+d.yScale.position(.5)+")").attr("stroke",d.config.currentPointStyle.stroke).attr("stroke-width",d.config.currentPointStyle.strokeWidth).attr("fill",d.config.currentPointStyle.fill).attr("fill-opacity",d.config.currentPointStyle.fillOpacity).attr("d",d.symbolGenerator()),b.exit().remove()},d.onVizMouseMove=function(a){d.updateTooltips(a,[d.data])},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-box-and-whisker",c),c},ma.add("addBoxAndWhisker",A),ma.add("updateBoxAndWhisker",B),ma.add("removeBoxAndWhisker",C),sonic.line=function(a,b){function c(b,e){var f;[d.config.cls,"sonic-line"];d.selection=b,d.computeData(e||{}),d.setScales(),d.computeColors(),f=b.selectAll(".sonic-line."+sonic.cleanIdForSelector(d.config.id)).data(d.data,function(a){return a.key}),f.enter().append("g").classed("sonic-line "+sonic.cleanIdForSelector(d.config.id),!0).append("path").attr("stroke-width",d.config.strokeWidth).attr("fill-opacity",0),f.attr("stroke",function(a,b){return d.colors[b]}).attr("fill",function(a,b){return d.colors[b]}).attr("opacity",function(a){return sonic.isSet(a.opacity)?a.opacity:1}),f.each(d.drawLine),f.each(d.drawPoints),f.each(d.drawLabels),f.each(d.drawTracerPoint),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,defaultColors:sonic.colors.colorMap(),colors:[],config:{id:null,cls:"",definedDataKey:"id",xDataKey:"x",yDataKey:"y",xScaleId:null,yScaleId:null,seriesKeys:null,seriesIndexes:null,stroke:"black",fill:"black",strokeWidth:3,fillOpacity:1,showPoints:!1,showLabels:!1,showLabelPointKey:"showLabel",labelPositionPointKey:"position",labelKey:"label",labelStyle:{fontSize:10,fontFamily:"arial",fontWeight:"normal",fill:null,stroke:"none",anchor:"middle",rotate:0,dx:0,dy:0},showPointTracer:!0,pointSize:4,highlightPointSize:6,minPixelsPerPoint:20,sort:!1,interpolate:!1,tooltip:{buffer:{type:"value",amount:null},type:"grouped",renderFn:null}}};return d.computeData=function(b){d.data=[],b.remove||(d.data=a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes).filter(function(a,b){return a.values.length>0?!0:void 0}))},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.computeColors=function(){d.data.forEach(function(a,b,c){c.length>1?(d.colors[b]=a.color||d.defaultColors(b),a.colorLegend=d.colors[b]):(d.colors[b]=a.color||d.config.stroke,a.colorLegend=d.colors[b])})},d.lineGenerator=function(){var a=d3.svg.line().defined(function(a){return sonic.isSet(a[d.config.definedDataKey])}).x(function(a){return d.xScale.position(a[d.config.xDataKey],"center")}).y(function(a){return d.yScale.position(a[d.config.yDataKey],"center")});return d.config.interpolate&&a.interpolate("basis"),a},d.drawLine=function(b,c){var e=d.lineGenerator();d3.select(this).selectAll("path").data(d.data).transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){var c=b.values;return d.config.sort&&(c=d.xScale.sort(c)),e(c)}).style("stroke-dasharray",function(a){return b.dashed})},d.drawLabels=function(b,c){var e,f=[];d.config.showLabels&&(f=b.values),e=d3.select(this).selectAll(".sonic-line-label").data(f),e.enter().append("text").classed("sonic-line-label",!0).attr("x",function(a){return d.xScale.position(a[d.config.xDataKey],"center")}).attr("y",function(a){return d.yScale.position(a[d.config.yDataKey],"center")}),e.attr("x",function(a){return"top"===a[d.config.labelPositionPointKey]?d.xScale.position(a[d.config.xDataKey],"center")-15:d.xScale.position(a[d.config.xDataKey],"center")+15}).attr("y",function(a){return"top"===a[d.config.labelPositionPointKey]?d.yScale.position(a[d.config.yDataKey],"center"):d.yScale.position(a[d.config.yDataKey],"center")+7}).style("fill",d.config.labelStyle.fill).style("stroke","none").style("font-size",d.config.labelStyle.fontSize+"px").style("font-family",d.config.labelStyle.fontFamily).style("font-weight",d.config.labelStyle.fontWeight).style("text-anchor",d.config.labelStyle.anchor).attr("dx",d.config.labelStyle.dx).attr("dy",d.config.labelStyle.dy).text(function(a){return a[d.config.showLabelPointKey]?a[d.config.labelKey]:""}).each(function(){var a=d3.select(this),b=a.text();/\\n/.test(b)&&(a.text(""),sonic.each(b.split("\\n").reverse(),function(b,c){var d=a.append("tspan").text(c).attr("x",a.attr("x"));0!==b&&d.attr("dy",-15)}))}),e.exit().attr("y",a.body().height()).remove()},d.drawPoints=function(b,c){var e,f=[];d.config.showPoints&&d.config.minPixelsPerPoint<a.body().width()/b.values.length&&(f=b.values),e=d3.select(this).selectAll("circle.line-point").data(f),e.enter().append("circle").classed(sonic.cleanIdForSelector(d.config.id)+" line-point",!0).attr("fill-opacity",d.config.fillOpacity),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("cx",function(a){return d.xScale.position(a[d.config.xDataKey],"center")}).attr("cy",function(a){return d.yScale.position(a[d.config.yDataKey],"center")}).attr("r",d.config.pointSize),e.exit().remove()},d.drawTracerPoint=function(a,b){var c,e=[];d.config.showPointTracer===!0?e.push({type:"mouse"},{type:"click"}):d.config.showTracerPoint!==!1&&e.push({type:d.config.showPointTracer}),c=d3.select(this).selectAll("circle.tracer-point").data(e),c.enter().append("circle").attr("class",function(b){return sonic.cleanIdForSelector(d.config.id)+" "+a.key+" tracer-point "+b.type}).attr("fill-opacity",.8).attr("opacity",0).attr("r",d.config.highlightPointSize),c.attr("cx",function(b,c){var e=this.getAttribute("cpId"),f=0,g=[];return e&&(g=a.values.filter(function(a){return sonic.isDate(a.id)?a.id.getTime().toString()===e:a.id.toString()===e}),g.length>0&&(f=d.getPositionFromCP([{point:g[0]}],0)[0])),f}).attr("cy",function(b,c){var e=this.getAttribute("cpId"),f=0,g=[];return e&&(g=a.values.filter(function(a){return sonic.isDate(a.id)?a.id.getTime().toString()===e:a.id.toString()===e}),g.length>0&&(f=d.getPositionFromCP([{point:g[0]}],0)[1])),f}),c.exit().remove()},d.onVizMouseMove=function(a){var b=[];return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),d3.selectAll("."+c.id()+".tracer-point.mouse").attr("cx",function(a,c){var e=d.getPositionFromCP(b,c);return e?e[0]:0}).attr("cy",function(a,c){var e=d.getPositionFromCP(b,c);return e?e[1]:0}).attr("opacity",function(c,e){return a&&d.getPositionFromCP(b,e)?1:0}).attr("stroke",function(a,c){return b&&b[c]?b[c].color:null}).attr("fill",function(a,c){return b&&b[c]?b[c].color:null}),b},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),d3.selectAll("."+c.id()+".tracer-point.mouse").attr("opacity",0),d3.selectAll("."+c.id()+".tracer-point.click").attr("cx",function(a,c){var e=d.getPositionFromCP(b,c);return e?e[0]:0}).attr("cy",function(a,c){var e=d.getPositionFromCP(b,c);return e?e[1]:0}).attr("cpId",function(a,c){var d=null;return b&&b.length>0&&b[c]&&(d=sonic.isDate(b[c].point.id)?b[c].point.id.getTime():b[c].point.id),d}).attr("opacity",function(c,e){return a&&d.getPositionFromCP(b,e)?1:0}),b},d.closestPoints=function(a){var b,c,e=[],f=a[0],g=a[1];if(d.config.tooltip&&sonic.isSet(d.config.tooltip.buffer.value)===!0){if(b=g>=d.yScale.rangeMin()&&g<=d.yScale.rangeMax(),b===!1)return[]}else c=!0;return b||c?(e=d.data.map(function(a){var b={xDist:null,point:null};return sonic.each(a,function(a,c){"values"!==a&&(b[a]=c)}),b}),d.data.forEach(function(a,b){a.values.forEach(function(a){var c=Math.abs(d.xScale.position(a[d.config.xDataKey],"center")-f),h=Math.abs(d.yScale.position(a[d.config.yDataKey],"center")-g);(!e[b].point||c<e[b].xDist)&&d.pointWithinBuffer(a,c)&&(e[b].point=a,e[b].xDist=c,e[b].yDist=h)})}),e=e.filter(function(a){return sonic.isSet(a.point)?!0:!1})):void 0},d.updateTooltips=function(b,e){var f;d.config.tooltip&&(f=d.config.tooltip.renderFn||d.renderTooltips,d.config.tooltip.associatedId=c.id(),b?e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.removeTooltip(d.config.tooltip):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+":</b>"+b.point[d.config.yDataKey],c+"</p>"}).reduce(function(a,b){return a+b})},d.pointWithinBuffer=function(a,b){var c=!0;return d.config.tooltip&&sonic.isSet(d.config.tooltip.buffer.amount)&&("value"===d.config.tooltip.buffer.type?d.xScale.domainRangeToInterval(b)>d.config.tooltip.buffer.amount&&(c=!1):b>d.config.tooltip.buffer.amount&&(c=!1)),c},d.getPositionFromCP=function(a,b){return a&&a.length>0&&a[b]?[d.xScale.position(a[b].point[d.config.xDataKey],"center"),d.yScale.position(a[b].point[d.config.yDataKey])]:null},d.isClosestPoint=function(a,b,c){return sonic.isArray(c)?c.filter(function(c){return c.key===a&&c.point[d.config.definedDataKey]===b[d.config.definedDataKey]}).length>0:!1},d.getLinePointRadius=function(a,b,c){var e=d3.select(this.parentNode).data()[0].key,f=d.config.pointSize;return sonic.isSet(c)&&d.isClosestPoint(e,a,c)&&(f=d.config.highlightPointSize),f},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-line",c),c},ma.add("addLine",D),ma.add("addLines",D),ma.add("updateLine",F),ma.add("updateLines",F),ma.add("removeLine",E),ma.add("removeLines",E),sonic.line.difference=function(a,b){function c(b,e){var f,g;e=e||{},d.selection=b,d.setScales(),d.computeData(e),f=b.selectAll(".sonic-difference."+c.id()).data(d.data).attr("opacity",0),g=f.enter().append("g").classed("sonic-difference "+c.id(),!0),g.append("svg").append("clipPath").attr("id","clip-below-"+c.id()).classed("clip-path clip-below",!0).append("path"),g.append("svg").append("clipPath").attr("id","clip-above-"+c.id(),!0).classed("clip-path clip-above",!0).append("path"),g.append("path").classed("clip-below",!0).attr("fill",d.config.decreaseColor).attr("fill-opacity",d.config.fillOpacity).attr("clip-path","url(#clip-below-"+c.id()+")"),g.append("path").classed("clip-above",!0).attr("fill",d.config.increaseColor).attr("fill-opacity",d.config.fillOpacity).attr("clip-path","url(#clip-above-"+c.id()+")"),f.each(d.updateDifferences),f.exit().attr("opacity",d.config.fillOpacity).transition().delay(a.animation().delay).duration(a.animation().duration).attr("opacity",0).remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{id:null,xDataKey:"x",yDataKey:"y",base:{key:null,index:null},compare:{key:null,index:null},interpolator:"linear",buffer:0,decreaseColor:"blue",increaseColor:"red",fillOpacity:.75}};return d.computeData=function(b){var c,e;d.data=[],c=a.dataBySeries(d.config.base.key,d.config.base.index),e=a.dataBySeries(d.config.compare.key,d.config.compare.index),b.remove||0===c.length||0===e.length||d.data.push({key:"single",baseValues:d.xScale.sort(c[0].values),compareValues:d.xScale.sort(e[0].values)})},d.areaGenerator=function(){return d3.svg.area().interpolate(d.config.interpolator).x(function(a){return d.xScale.position(a[d.config.xDataKey])}).y1(function(a){return d.yScale.position(a[d.config.yDataKey])})},d.setScales=function(){d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.updateDifferences=function(b,c){var e=d3.select(this),f=d.areaGenerator(),g=e.data()[0];f.y0(a.body().height()),e.select(".clip-path.clip-below path").transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){return f(a.baseValues)}),f.y0(0),e.select(".clip-path.clip-above path").transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){return f(a.baseValues)}),f.y0(function(a,b){var c,e;return c=d.xScale.nearest(a,g.compareValues),e=c.dist<=d.config.buffer?c.point[d.config.yDataKey]:a[d.config.yDataKey],d.yScale.position(e)}),e.select("path.clip-above").transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){return f(a.baseValues)}),e.select("path.clip-below").transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){return f(a.baseValues)}),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("opacity",d.config.fillOpacity)},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-difference",c),c},ma.add("addDifference",G),ma.add("removeDifference",H),sonic.line.forecast=function(a,b){function c(b){var e,f;d.selection=b,d.computeData(),d.setScales(),e=b.selectAll(".sonic-forecast."+c.id()).data(d.data,function(a){return a.key}),f=e.enter().append("g").classed("sonic-forecast "+c.id(),!0),e.each(d.drawForecast),e.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{xDataKey:"x",yDataKey:"y",strokeWidth:3,stroke:"yellow",fanColor:"lightblue",seriesKeys:null,seriesIndexes:null,fromSeriesKey:null,fromSeriesIndex:null,tooltip:{buffer:{type:"value",amount:null},renderFn:null}}};return d.drawForecast=function(a,b){var c=this;d.drawFan.call(c,a,b),d.drawLine.call(c,a,b)},d.drawFan=function(b,e){var f,g;g=b.values.length>0&&sonic.isSet(b.values[b.values.length-1].confidences)?b.values[b.values.length-1].confidences.sort(sonic.sortByProp("id")):[],f=d3.select(this).selectAll("g.sonic-forecast."+c.id()+" path.area").data(g,function(a){return a.id}),f.enter().insert("path",":first-child").classed("area",!0).attr("fill",function(a,b){return d3.rgb(d.config.fanColor).darker(b+1)}),f.transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a,c){return d.areaGenerator(a.id)(b.values)}),f.exit().remove()},d.drawLine=function(b,e){var f,g;g=0===b.values.length?[]:[1],f=d3.select(this).selectAll("g.sonic-forecast."+c.id()+" path.line").data(g),f.enter().append("path").classed("line",!0).attr("stroke-width",d.config.strokeWidth).attr("stroke",function(a,c){return d.getLineColor.call(this,a,c,b)}).attr("fill-opacity",0),f.data(b.values).transition().delay(a.animation().delay).duration(a.animation().duration).attr("d",function(a){var c=b.values;return d.config.sort&&(c=d.xScale.sort(c)),d.lineGenerator()(c)}),f.exit().remove()},d.getLineColor=function(a,b,c){return c.color||d.config.stroke},d.lineGenerator=function(){return d3.svg.line().x(function(a){return d.xScale.position(a[d.config.xDataKey])}).y(function(a){return d.yScale.position(a[d.config.yDataKey])})},d.areaGenerator=function(a){var b=function(b){return b.confidences.filter(function(b){return b.id===a?!0:!1}).pop()};return d3.svg.area().x(function(a){return d.xScale.position(a[d.config.xDataKey])}).y0(function(a){return a.confidences?d.yScale.position(b(a).low):d.yScale.position(a[d.config.yDataKey])}).y1(function(a){return a.confidences?d.yScale.position(b(a).high):d.yScale.position(a[d.config.yDataKey])})},d.computeData=function(){d.data=[],a.data().forEach(function(a,b){sonic.isSet(d.config.seriesKeys)&&-1!==d.config.seriesKeys.indexOf(a.key)?d.data.push(a):sonic.isSet(d.config.seriesIndexes)&&-1!==d.config.seriesIndexes.indexOf(b)?d.data.push(a):sonic.isSet(d.config.seriesKeys)||sonic.isSet(d.config.seriesIndexes)||d.data.push(a)}),d.isValidDataSet()&&d.addLastActualValue()},d.isValidDataSet=function(){return d.data.every(function(a){return sonic.isSet(a)&&sonic.isArray(a.values)})},d.addLastActualValue=function(){var b,c;d.config.fromSeriesKey?b=a.dataByKey(d.config.fromSeriesKey):d.config.fromSeriesIndex&&(b=a.dataByKey(d.config.fromSeriesKey)),b&&d.data.forEach(function(a){a.values.length>0&&(c=sonic.clone(b.values[b.values.length-1]),c.nonForecast=!0,a.values.unshift(c))})},d.setScales=function(){var b,e;sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id()),b=d.computeMinY(),e=d.computeMaxY(),(b<d.yScale.domainMin()||e>d.yScale.domainMax())&&(d.yScale.domain([b,e],!0),a.refreshRegistry(c.id()))},d.computeMinY=function(){return d3.min(d.data,function(a){return d3.min(a.values,function(a){return a.confidences?d3.min(a.confidences,function(a){return a.low}):a[d.config.yDataKey]})})},d.computeMaxY=function(){return d3.max(d.data,function(a){return d3.max(a.values,function(a){return a.confidences?d3.max(a.confidences,function(a){return a.high}):a[d.config.yDataKey]})})},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),b},d.closestPoints=function(a){var b,c=a[0];a[1];return b=d.data.map(function(a){return{key:a.key,dist:null,point:null}}),d.data.forEach(function(a,e){a.values.forEach(function(a){var f;a.nonForecast||(f=Math.abs(d.xScale.position(a[d.config.xDataKey])-c),(!b[e].point||f<b[e].dist)&&d.pointWithinBuffer(a,f)&&(b[e].point=a,b[e].dist=f))})}),b=b.filter(function(a){return sonic.isSet(a.point)?!0:!1})},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+":</b>"+b.point[d.config.yDataKey],b.point.confidences&&(c+=b.point.confidences.map(function(a){return"<br /><b>"+a.id+"%:</b> ("+a.low+", "+a.high+")"}).join("")),c+"</p>"}).reduce(function(a,b){return a+b})},d.pointWithinBuffer=function(a,b){var c=!0;return sonic.isSet(d.config.tooltip.buffer.amount)&&("value"===d.config.tooltip.buffer.type?d.xScale.domainRangeToInterval(b)>d.config.tooltip.buffer.amount&&(c=!1):b>d.config.tooltip.buffer.amount&&(c=!1)),
c},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-forecast",c),c},ma.add("addForecast",I),sonic.line.rule=function(a,b){function c(b,e){var f,g;[d.config.cls,"sonic-rule"];d.selection=b,e=e||{},sonic.isSet(d.config.axisPin.id)&&(g=a.componentSingleton().find("sonic-axis",d.config.axisPin.id)[0].scale()),d.computeData(e,g),f=b.selectAll(".sonic-rule."+c.id()).data(d.data,function(){return c.id()}),f.enter().append("g").classed("sonic-rule "+c.id()+" "+d.config.type,!0).classed("mouse",function(a){return d.config.followMouse}).attr("stroke",d.config.stroke).append("path").attr("stroke-width",d.config.strokeWidth).attr("opacity",function(a,b){return a[0].enabled?1:0}),f.each(d.drawRule),f.exit().remove(),a.registerVisibleContent(c,!1)}var d={config:{id:null,cls:"",axisPin:{id:null,x:null,y:null},dashed:{show:!1,stroke:"3,3"},stroke:"grey",strokeWidth:1,position:null,type:null,length:null,offset:{length:0},followMouse:!1}};return d.drawRule=function(b,c){var e,f=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}),g=a.animation().delay,h=a.animation().duration;d.config.followMouse?(g=0,h=0):d.config.animation&&(g=sonic.isSet(d.config.animation.delay)?d.config.animation.delay:g,h=sonic.isSet(d.config.animation.duration)?d.config.animation.duration:h),e=d3.select(this).select("path").transition().delay(g).duration(h).attr("d",f),d.config.dashed.show&&(e=e.style("stroke-dasharray",d.config.dashed.stroke))},d.computeData=function(b,c){var e,f,g=d.config.position,h=!0,i=g*a.body().height(),j=g*a.body().width();d.data=[],b.remove||(sonic.isSet(g)||sonic.isSet(d.config.axisPin.x)||sonic.isSet(d.config.axisPin.y)||(h=!1,g=0),"x"===d.config.type?(d.config.length?e=d.config.length:(e=a.body().width(),"right"===d.config.offset.anchor&&(e=-1*e)),f=d.config.offset.length,"right"===d.config.offset.anchor&&(f+=a.body().width()),sonic.isSet(d.config.axisPin.y)&&(i=c.position(d.config.axisPin.y)),d.data.push([{x:f,y:i,enabled:h},{x:e+f,y:i,enabled:h}])):"y"===d.config.type&&(d.config.length?e=d.config.length:(e=-1*a.body().height(),"top"===d.config.offset.anchor&&(e=-1*e)),f=a.body().height()+d.config.offset.length,"top"===d.config.offset.anchor&&(f=d.config.offset.length),sonic.isSet(d.config.axisPin.x)&&(j=c.position(d.config.axisPin.x)),d.data.push([{x:j+(d.config.offset&&d.config.offset.x?d.config.offset.x:0),y:f,enabled:h},{x:j+(d.config.offset&&d.config.offset.x?d.config.offset.x:0),y:e+f,enabled:h}])))},d.onVizMouseMove=function(a){a?(d3.select(".sonic-rule."+c.id()+".mouse.x path").attr("opacity",1).attr("transform",function(b){return"translate(0 , "+a[1]+")"}),d3.select(".sonic-rule."+c.id()+".mouse.y path").attr("opacity",1).attr("transform",function(b){return"translate("+a[0]+", 0)"})):d3.select(".sonic-rule."+c.id()+".mouse path").attr("opacity",0)},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-rule",c),c},ma.add("addRule",J),ma.add("removeRule",K),ma.add("updateRule",M),ma.add("addCrosshair",L),sonic.bar=function(a,b){function c(b,e){var f,g,h,i,j=[d.config.cls,"sonic-bar"];d.selection=b,d.computeData(e||{}),d.setScales(),d.computeBarWidth(),f=b.selectAll(j.join(".")+"."+c.id()).data(d.data,function(a){return a.key}),f.enter().append("g").classed(j.join(" ")+" "+c.id(),!0),h=sonic.isSet(d.config.animation.delay)?d.config.animation.delay:a.animation().delay,i=sonic.isSet(d.config.animation.duration)?d.config.animation.duration:a.animation().duration,g=h>0||i>0?f.transition().delay(h).duration(i):f,g.attr("stroke",function(a,b){return d3.rgb(d.getBarColor(a,b)).darker().toString()}).attr("fill",d.getBarColor),f.each(function(a,b){d.drawBars.call(this,a,b,e||{})}),f.each(d.setupLegend),f.exit().remove(),d.config.zoom&&d.addZoom(e),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,barGroupWidth:null,barWidth:null,groupIndex:null,defaultColors:sonic.colors.colorMap(),config:{type:"grouped",id:null,cls:"",definedDataKey:"id",xDataKey:"x",yDataKey:"y",labelKey:"label",xScaleId:null,yScaleId:null,seriesKeys:null,seriesIndexes:null,stroke:"black",fill:"",animation:{duration:null,delay:null},strokeWidth:1,fillOpacity:1,barPosition:"center",minBarWidth:8,maxBarWidth:50,barWidth:null,barPadding:0,barGroupPadding:5,highlightOnHover:!0,drawLabels:!1,labelStyle:{fontSize:10,fontFamily:"arial",fontWeight:"normal",fill:null,stroke:"none",anchor:"middle",rotate:0,dx:0,dy:0},tooltip:{type:"grouped",renderFn:null},zoom:!1,dependent:!1,multiSelect:!0,selectedBars:[]}};return d.addZoom=function(b){a.addZoom(c.id(),{zoom:{opts:b,fn:d.zoomAction}},d.xScale,null)},d.zoomAction=function(a){c(d.selection,a)},d.computeData=function(b){d.data=[],b.remove||(d.data=sonic.clone(a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes)),d.groupIndex={},0!==d.data.length&&(d.data.forEach(function(a){a.values=a.values.filter(function(a){return d.xScale&&d.yScale&&d.config.zoom&&d.xScale.domain?!(a[d.config.xDataKey]<d.xScale.domain()[0]||a[d.config.xDataKey]>d.xScale.domain()[1]):!0}),a.values.forEach(function(b){d.groupIndex[b[d.config.xDataKey]]||(d.groupIndex[b[d.config.xDataKey]]=[]),-1===d.groupIndex[b[d.config.xDataKey]].indexOf(a.key)&&d.groupIndex[b[d.config.xDataKey]].push(a.key)})}),"stacked"===d.config.type&&d.computeStackedData()))},d.computeStackedData=function(){var a=d3.layout.stack().values(function(a){return a.values}).x(function(a){return a[d.config.xDataKey]}).y(function(a){return a[d.config.yDataKey]});d.data=sonic.clone(d.data).map(function(a){return d3.keys(d.groupIndex).forEach(function(b){var c=b,e={};sonic.string.isNumeric(c)&&(c=parseInt(c,10)),a.values.some(function(a){return sonic.isDate(a[d.config.xDataKey])?(sonic.isDate(c)||(c=new Date(c)),a[d.config.xDataKey].getTime()===c.getTime()?!0:!1):a[d.config.xDataKey]===c?!0:!1})||(e[d.config.xDataKey]=c,e[d.config.yDataKey]=0,e.filler=!0,a.values.push(e))}),a.values.sort(function(a,b){return a[d.config.xDataKey]<b[d.config.xDataKey]?-1:1}),a}),d.data=a(d.data)},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id()),d.config.dependent||("stacked"===d.config.type?d.transitionAxisToStacked():d.transitionAxisToGrouped())},d.setupLegend=function(a,b){d3.select(this).selectAll("rect").attr(c.id()+"-data-legend",function(b){return a.name||a.key}).attr("data-legend-color",function(b){return a.color||a.stroke||b.color||b.stroke})},d.drawBars=function(b,c,e){var f,g,h=d.getBarGroupDelay,i=a.animation().duration;f=d3.select(this).selectAll("rect").data(function(a){return a.values},function(a){return a[d.config.definedDataKey]}),sonic.isSet(d.config.animation.delay)&&(h=d.config.animation.delay),sonic.isSet(d.config.animation.duration)&&(i=d.config.animation.duration),f.enter().append("rect").attr("stroke-width",d.config.strokeWidth).attr("fill-opacity",d.config.fillOpacity).attr("x",d.getBarAlignment).attr("width",d.barWidth).attr("y",d.getBarInitY).attr("height",0).attr("fill",d.getDataPointColor).attr("stroke",d.getDataPointStrokeColor),g=h>0||i>0?f.transition().delay(h).duration(i):f,"stacked"===d.config.type?g.attr("fill",d.getDataPointColor).attr("stroke",d.getDataPointStrokeColor).attr("stroke-width",d.config.strokeWidth).attr("fill-opacity",d.config.fillOpacity).attr("y",function(a){var b=d.yScale.position(a.y0)-d.yScale.position(a.y0+a[d.config.yDataKey],"center"),c=d.yScale.position(a.y0+a[d.config.yDataKey],"center");return 0>b&&(c+=b),c}).attr("height",function(a){var b=d.yScale.position(a.y0)-d.yScale.position(a.y0+a[d.config.yDataKey],"center");return 0>b&&(b*=-1),b}).transition().attr("x",d.getBarAlignment).attr("width",function(a){return d.barWidth}):g.attr("fill",d.getDataPointColor).attr("stroke",d.getDataPointStrokeColor).attr("stroke-width",d.config.strokeWidth).attr("fill-opacity",d.config.fillOpacity).attr("x",function(a,c){return d.getGroupedBarPosition(a,c,b.key)}).attr("width",d.barWidth).transition().attr("y",d.getGroupedBarY).attr("height",d.getGroupedBarHeight),sonic.isSet(d.config.animation.delay)||(h=a.animation().delay),g=h>0||a.animation().duration>0?f.exit().transition().delay(h).duration(a.animation().duration):f.exit(),g.attr("y",function(b){return a.body().height()}).attr("height",0).remove(),d.config.drawLabels!==!1&&d.drawLabels.call(this,b,c,e)},d.getLabelX=function(a,b,c){var e;return e=d.getGroupedBarPosition(a,b,c.key),("center"===d.config.barPosition||"bin"===d.config.barPosition)&&(e+=d.barWidth/2),e},d.getLabelY=function(a,b,c){var e;return e="top"===d.config.drawLabels?d.getGroupedBarY.apply(this,arguments)-5:d.getGroupedBarY.apply(this,arguments)+d.getGroupedBarHeight.apply(this,arguments)+15},d.drawLabels=function(b,c,e){var f,g,h=d.getBarGroupDelay,i=a.animation().duration;f=d3.select(this).selectAll(".sonic-bar-label").data(function(a){return a.values},function(a){return a[d.config.definedDataKey]}),sonic.isSet(d.config.animation.delay)&&(h=d.config.animation.delay),sonic.isSet(d.config.animation.duration)&&(i=d.config.animation.duration),f.enter().append("text").classed("sonic-bar-label",!0).attr("x",d.getBarAlignment).attr("y",d.getBarInitY),g=h>0||i>0?f.transition().delay(h).duration(i):f,"stacked"===d.config.type||g.attr("x",function(a,c){return d.getLabelX.call(this,a,c,b)}).attr("y",function(a,c){return d.getLabelY.call(this,a,c,b)}).style("fill",d.config.labelStyle.fill).style("stroke","none").style("font-size",d.config.labelStyle.fontSize+"px").style("font-family",d.config.labelStyle.fontFamily).style("font-weight",d.config.labelStyle.fontWeight).style("text-anchor",d.config.labelStyle.anchor).attr("transform",function(a,c){return"rotate("+d.config.labelStyle.rotate+", "+d.getLabelX.call(this,a,c,b)+", "+d.getLabelY.call(this,a,c,b)+")"}).attr("dx",d.config.labelStyle.dx).attr("dy",d.config.labelStyle.dy).text(function(a){return a[d.config.labelKey]}).each(function(){var a=d3.select(this),b=a.text();/\\n/.test(b)&&(a.text(""),sonic.each(b.split("\\n").reverse(),function(b,c){var d=a.append("tspan").text(c).attr("x",a.attr("x"));0!==b&&d.attr("dy",-15)}))}),sonic.isSet(d.config.animation.delay)||(h=a.animation().delay),g=h>0||a.animation().duration>0?f.exit().transition().delay(h).duration(a.animation().duration):f.exit(),g.attr("y",a.body().height()).remove()},d.computeBarWidth=function(){var a=d.data.length;"ordinal"===d.xScale.type()?d.barGroupWidth=d.xScale.rangeBand():sonic.isObject(d.config.barWidth)?d.barGroupWidth=d.xScale.domainIntervalToRange(d.config.barWidth.amount):d.barGroupWidth=Math.floor(d.xScale.rangeExtent()/d.xScale.domainExtent()),d.barGroupWidth=d.barGroupWidth-2*d.config.barGroupPadding,sonic.isSet(d.config.barWidth)?sonic.isObject(d.config.barWidth)?d.barWidth=d.xScale.domainIntervalToRange(d.config.barWidth.amount):d.barWidth=d.config.barWidth:"stacked"===d.config.type||1===a?d.barWidth=d.barGroupWidth:d.barWidth=Math.floor((d.barGroupWidth-a*d.config.barPadding*2)/a),sonic.isSet(d.config.barWidth)||(d.barWidth<d.config.minBarWidth?d.barWidth=d.config.minBarWidth:d.barWidth>d.config.maxBarWidth&&(d.barWidth=d.config.maxBarWidth)),sonic.isSet(d.config.tooltip.buffer)||(d.config.tooltip.buffer={type:"pixel",value:d.barWidth})},d.getBarColor=function(b,c){var e=a.data()[c].values,f=b.color||d.config.fill||d.defaultColors(c);return a.data()[c].colorLegend=e.length>0&&e[0].color||f,f},d.getDataPointColor=function(a,b){return a.color||void 0},d.getDataPointStrokeColor=function(a,b){return a.stroke?a.stroke:a.color?d3.rgb(a.color).darker():void 0},d.getBarSeriesIdx=function(a){var b=0;return d.data.forEach(function(c,d){c.values.indexOf(a)>=0&&(b=d)}),b},d.getBarGroupDelay=function(a,b){var c,e=0;return sonic.isSet(d.groupIndex)&&(c=d3.keys(d.groupIndex).sort(function(a,b){var c=sonic.string.isNumeric(a)?parseInt(a,10):a,e=sonic.string.isNumeric(b)?parseInt(b,10):b;return d.xScale.position(c,d.config.barPosition)<d.xScale.position(e,d.config.barPosition)?-1:1}).indexOf(String(a[d.config.xDataKey])),e=-1===c?0:200*c),e},d.getBarAlignment=function(a,b){var c=d.xScale.position(a[d.config.xDataKey],d.config.barPosition);return"center"===d.config.barPosition&&(c-=d.barWidth/2),c},d.getGroupedBarPosition=function(a,b,c,e){var f=d.groupIndex[a[d.config.xDataKey]],g=0,h=d.xScale.position(a[d.config.xDataKey],d.config.barPosition);return sonic.isSet(f)&&(g=f.indexOf(c),-1!==g&&(h+=g*(d.barWidth+2*d.config.barPadding),"center"===d.config.barPosition&&(h+=-1*f.length*(d.barWidth+d.config.barPadding)/2))),e&&"center"===e?h+=(d.barWidth+d.config.barPadding)/2:e&&"max"===e&&(h+=d.barWidth+2*d.config.barPadding),h},d.getGroupedBarY=function(a,b){var c=a.y0,e=a[d.config.yDataKey];return sonic.isSet(c)&&(e=Math.max(e,c)),d.yScale.position(e,d.config.barPosition)},d.getBarInitY=function(b,c){var e=b.y0,f=a.body().height();return sonic.isSet(e)&&"grouped"===d.config.type&&(f=d.yScale.position(b.y0,d.config.barPosition)),f},d.getGroupedBarHeight=function(b,c){var e=b.y0,f=a.body().height();b[d.config.yDataKey];return sonic.isSet(e)&&(f=d.yScale.position(e,d.config.barPosition)),Math.abs(d.yScale.position(b[d.config.yDataKey],d.config.barPosition)-f)},d.transitionAxisToStacked=function(){var b=d.yScale.domainMax();d.yScale.domainMax(d3.max(d.data,function(a){return d3.max(a.values,function(a){return a.y0+a[d.config.yDataKey]})})),b!==d.yScale.domainMax()&&a.refreshRegistry(c.id())},d.transitionAxisToGrouped=function(){var b=d.yScale.domainMax();d.yScale.domainMax(d3.max(d.data,function(a){return d3.max(a.values,function(a){return a[d.config.yDataKey]})})),b!==d.yScale.domainMax()&&a.refreshRegistry(c.id())},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a,d.config.tooltip.type)),d.barStyleUpdate(b),d.updateTooltips(a,b),b},d.onVizClick=function(a){var b,c,e,f,g,h;if(a&&(b=d.closestPoints(a)),d.config.multiSelect){if(e=b[0].point,d3.event.ctrlKey)c=d.config.selectedBars.indexOf(e),-1!==c?d.config.selectedBars.splice(c,1):d.config.selectedBars.push(e);else if(d3.event.shiftKey&&d.config.selectedBars.length>0){if(g=d.data[0].values.indexOf(d.config.selectedBars[0]),h=d.data[0].values.indexOf(e),d.config.selectedBars.splice(0,d.config.selectedBars.length),-1!==g&&-1!==h)for(d.config.selectedBars.push(d.data[0].values[g]),g>h?(f=g,g=h,h=f):(g+=1,h+=1),c=g;h>c;c++)d.config.selectedBars.push(d.data[0].values[c])}else d.config.selectedBars.splice(0,d.config.selectedBars.length),d.config.selectedBars.push(e);d.barStyleUpdate(b)}return b},d.barStyleUpdate=function(a){var b=!1;d.config.multiSelect?b=!0:(b=!1,d.config.selectedBars.splice(0,d.config.selectedBars.length)),d.config.highlightOnHover&&d.selection.selectAll("."+c.id()+" rect").style("fill",function(c,e){var f=c.color||d3.select(this.parentNode).attr("fill");return b&&sonic.array.contains(d.config.selectedBars,c)?d3.rgb(f).brighter():a&&a.filter(function(a){return c===a.point}).length>0?d3.rgb(f).brighter():null}).attr("stroke-width",function(c,e){var f=d.config.strokeWidth;return b&&sonic.array.contains(d.config.selectedBars,c)?parseInt(this.getAttribute("stroke-width"),10):a&&a.filter(function(a){return c===a.point}).length>0?f+1:f})},d.closestPoints=function(a,b){var c,e,f,g,h,i,j,k=a[0];a[1];return c=d.data.map(function(a){var b={point:null,dist:null};return sonic.each(a,function(a,c){"values"!==a&&(b[a]=c)}),b}),d.data.forEach(function(a,e){for(var l=0;l<a.values.length;l++)f=a.values[l],g=d.xScale.position(f[d.config.xDataKey]),h=d.xScale.position(f[d.config.xDataKey])+Math.max(d.barGroupWidth,d.barWidth||0),i=null,j=!1,"stacked"===d.config.type&&f.filler===!0&&(j=!0),!j&&k>=g&&h>=k&&("single"!==b?i=Math.abs(d.xScale.position(f[d.config.xDataKey],d.config.barPosition)-k):d.config.stacked||(i=Math.abs(d.getGroupedBarPosition(f,null,a.key,d.config.barPosition)-k)),(!c[e]||null===c[e].dist||null!==c[e].dist&&i<c[e].dist)&&(c[e].point=f,c[e].dist=i))}),c=c.filter(function(b){if(!sonic.isSet(b.point))return!1;if(sonic.isSet(d.config.tooltip.buffer)&&sonic.isSet(d.config.tooltip.buffer.amount))if("value"===d.config.tooltip.buffer.type){if(d.xScale.domainRangeToInterval(Math.abs(d.xScale.position(b.point[d.config.xDataKey])-a[0]))>d.config.tooltip.buffer.amount)return!1}else if(Math.abs(d.xScale.position(b.point[d.config.xDataKey])-a[0])>d.config.tooltip.buffer.amount)return!1;return!0}),"single"===b&&c.length>0&&(e=c[0],c.forEach(function(a){a.dist<e.dist&&(e=a)}),c=[e]),"stacked"===d.config.type&&c.reverse(),c},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+":</b>"+b.point[d.config.yDataKey],c+"</p>"}).reduce(function(a,b){return a+b})},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-bar",c),c},ma.add("addBars",N),ma.add("updateBars",O),ma.add("removeBars",P),sonic.bar.significance=function(a,b){function c(b){var e;d.selection=b,d.computeData(),d.setScales(),e=b.selectAll(".sonic-significance-bar."+c.id()).data(d.data,function(a){return a.key}),e.enter().append("g").classed("sonic-significance-bar "+c.id(),!0),e.each(d.drawBars),e.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{id:null,xDataKey:"x",yDataKey:"y",zDataKey:"z",xScaleId:null,yScaleId:null,low:{color:"blue",threshold:.25},high:{color:"red",threshold:.75},nonSignificanceBars:{hidden:!0,color:"transparent"},brightShading:{active:!1,hoverColor:null},fillOpacity:.75,strokeWidth:1,barPadding:3,widthPadVal:0,pointerHand:!1,tooltip:{type:"grouped",renderFn:null},suppressGrouping:!1}};return d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),b},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),d.selection.selectAll("g.sonic-significance-bar rect").attr("fill",function(a,c){var e;return e=d.config.brightShading.active?d.brightShade(d.config[a.type].color,a.type,a.z):d.config[a.type].color,b&&b.point[d.config.yDataKey]===a[d.config.yDataKey]&&b.point[d.config.xDataKey]===a[d.config.xDataKey]?d.config.brightShading.hoverColor||d3.rgb(d.config[a.type].color).brighter().brighter().toString():e}),b},d.closestPoints=function(a){var b=a[0],c=a[1],e=null;return d.data.forEach(function(a,f){a.values.forEach(function(f){var g=Math.abs(d.xScale.position(f[d.config.xDataKey])),h=Math.abs(d.xScale.position(f[d.config.xDataKey])+d.getRectWidth(f)),i=Math.abs(d.yScale.position(f[d.config.yDataKey])),j=Math.abs(d.yScale.position(f[d.config.yDataKey])+d.getRectHeight(f));b>=g&&h>=b&&c>=i&&j>=c&&(e={point:f,key:a.key})})}),e},d.drawBars=function(b,c){var e=d3.select(this).selectAll("rect").data(function(a){return a.values});e.enter().append("rect").attr("stroke-width",d.config.strokeWidth).attr("fill-opacity",d.config.fillOpacity).attr("series",function(a){return a[d.config.yDataKey]}).attr("cursor",d.config.pointerHand?"pointer":""),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("stroke-width",d.config.strokeWidth).attr("stroke",function(a,b){return"nonSignificanceBars"===a.type?void 0:d3.rgb(d.config[a.type].color).darker().toString()}).attr("fill",function(a,b){return d.config.brightShading.active?d.brightShade(d.config[a.type].color,a.type,a.z):d.config[a.type].color}).attr("x",function(a,b){return d.xScale.position(a[d.config.xDataKey])}).attr("y",function(a){return d.yScale.position(a[d.config.yDataKey])+d.config.barPadding}).attr("width",function(a){return d.getRectWidth(a)}).attr("height",function(a){return d.getRectHeight(a)}),e.exit().remove()},d.getRectWidth=function(a){var b;return b=sonic.isSet(a.toKey)?d.xScale.position(a.toKey)-d.xScale.position(a[d.config.xDataKey]):d.xScale.domainIntervalToRange(d.config.widthPadVal)},d.getRectHeight=function(a){return d.yScale.rangeBand()-2*d.config.barPadding},d.transformPoint=function(a,b,c){var e={};return e[d.config.xDataKey]=b[0][d.config.xDataKey],e.toKey=b.length>1?b[b.length-1][d.config.xDataKey]:null,e[d.config.yDataKey]=a.key,e.type=c,e.ztotal=b.length>1?b.reduce(function(a,b){return{z:a.z+b.z}}).z:b[0].z,e.z=e.ztotal/b.length,e.breakdown=b,e},d.computeData=function(){d.data=[],a.data().forEach(function(a){var b,c=[],e=[],f=[],g={key:a.key,values:[]};b=a.values.sort(sonic.sortByProp(d.config.xDataKey)),b.forEach(function(h,i){var j={};d.config.nonSignificanceBars.hidden===!1&&("insignificant"===h[d.config.zDataKey]||h[d.config.zDataKey]>=d.config.low.threshold&&h[d.config.zDataKey]<=d.config.high.threshold)&&(f.push(h),j=d.transformPoint(a,f,"nonSignificanceBars"),g.values.push(j),f=[]),h[d.config.zDataKey]<d.config.low.threshold&&c.push(h),c.length&&(d.config.suppressGrouping||h[d.config.zDataKey]>d.config.low.threshold||i===b.length-2)&&(j=d.transformPoint(a,c,"low"),g.values.push(j),c=[]),h[d.config.zDataKey]>d.config.high.threshold&&e.push(h),e.length&&(d.config.suppressGrouping||h[d.config.zDataKey]<d.config.high.threshold||i===b.length-2)&&(j=d.transformPoint(a,e,"high"),g.values.push(j),e=[])}),d.data.push(g)})},d.setScales=function(){d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:"x"}),d.config.xScaleId=d.xScale.id()),b.widthPadVal||("time"===d.xScale.type()?d.config.widthPadVal=864e5:"linear"===d.xScale.type()&&(d.config.widthPadVal=1)),d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:"y"}),d.config.yScaleId=d.yScale.id())},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return"<p><b>"+d.config.xDataKey+": </b>"+a.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+": </b>"+a.point[d.config.yDataKey]+"<br /><b>"+d.config.zDataKey+": </b>"+a.point[d.config.zDataKey]+"</p>"},d.brightShade=function(a,b,c){var e=100;return"high"===b?d3.rgb(d.config[b].color).brighter(Math.abs(c-d.config.high.threshold)*e).toString():"low"===b?d3.rgb(d.config[b].color).brighter(Math.abs(c-d.config.low.threshold)*e).toString():d.config[b].color},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-significance-bar",c),c},ma.add("addSignificanceBars",Q),ma.add("updateSignificanceBars",R),sonic.bar.overlay=function(a,b){function c(b,e){var f,g=[d.config.cls,"sonic-bar-overlay"];d.selection=b,d.computeData(e||{}),d.setScales(),f=b.selectAll(g.join(".")+"."+c.id()).data(d.data,function(a){return a.key}),f.enter().append("g").classed(g.join(" ")+" "+c.id(),!0),f.each(d.drawOverlays),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{xDataKey:"x",xToDataKey:"x2",seriesKeys:null,seriesIndexes:null,fill:"orange",fillOpacity:.5,stroke:"#ccc",strokeWidth:"0px",tooltip:{renderFn:null},animation:{delay:null,duration:null}}};return d.drawOverlays=function(b,c){var e=d3.select(this).selectAll("rect").data(function(a){return a.values});e.enter().append("rect").attr("fill",function(a,c){return d.getFillColor.call(this,a,c,b)}).attr("fill-opacity",d.config.fillOpacity).attr("x",d.getX).attr("y",d.getY).attr("width",d.getWidth).attr("height",0).attr("stroke",function(a,b){return a.stroke||d.config.stroke}).attr("stroke-width",function(a,b){return a.strokeWidth||d.config.strokeWidth}),e.transition().delay(sonic.isSet(d.config.animation.delay)?d.config.animation.delay:a.animation().delay).duration(sonic.isSet(d.config.animation.duration)?d.config.animation.duration:a.animation().duration).attr("fill",function(a,c){return d.getFillColor.call(this,a,c,b)}).attr("fill-opacity",d.config.fillOpacity).attr("x",d.getX).attr("y",d.getY).attr("width",d.getWidth).attr("height",d.getHeight).attr("stroke",function(a,b){return a.stroke||d.config.stroke}).attr("stroke-width",function(a,b){return a.strokeWidth||d.config.strokeWidth}),e.exit().remove()},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.yScale&&(d.config.yScaleId=d.yScale.id()))},d.computeData=function(b){d.data=[],b.remove||(d.data=a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes))},d.getX=function(a,b){return Math.min(d.xScale.position(a[d.config.xDataKey]),d.xScale.position(a[d.config.xToDataKey]))},d.getWidth=function(a,b){return Math.abs(d.xScale.position(a[d.config.xToDataKey])-d.xScale.position(a[d.config.xDataKey]))},d.getHeight=function(b,c){return d.yScale?d.yScale.rangeExtent():a.body().height()},d.getY=function(a,b){return d.yScale?d.yScale.rangeMin():0},d.getFillColor=function(a,b,c){return c.color||a.color||d.config.fill},d.getStrokeColor=function(a,b,c){return d3.rgb(d.getFillColor(a,b,c)).darker().toString()},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),b},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),b},d.closestPoints=function(a){var b=[],c=a[0];a[1];return d.data.forEach(function(a,e){a.values.forEach(function(e){var f,g,h=d.xScale.position(e[d.config.xDataKey]),i=d.xScale.position(e[d.config.xToDataKey]),j={};h>i&&(f=h,h=i,i=f),g=Math.abs((i-h)/2-c),c>=h&&i>=c&&(j={point:e,dist:g},sonic.each(a,function(a,b){"values"!==a&&(j[a]=b)}),b.push(j))})}),b},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.xToDataKey+":</b>"+b.point[d.config.xToDataKey]+"<br />",c+"</p>"}).join("")},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-bar-overlay",c),c},ma.add("addOverlayBars",S),ma.add("removeOverlayBars",T),ma.add("updateOverlayBars",U),sonic.bar.matrix=function(a,b){function c(b){var e;d.selection=b,d.computeData(),d.setScales(),e=b.selectAll(".sonic-matrix."+c.id()).data(d.data,function(a){return a.key}),e.enter().append("g").classed("sonic-matrix "+c.id(),!0),e.each(d.drawRects),e.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,zScale:null,config:{xDataKey:"x",yDataKey:"y",zDataKey:"z",quantize:!0,barPadding:5,buckets:5,fillOpacity:.6,colors:["#FF0000","#f46d43","#f6faaa","#abdda4","#008000"],tooltip:{type:"grouped"}}};return d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),b},d.closestPoints=function(a){var b=a[0],c=a[1],e=null;return d.data.forEach(function(a,f){a.values.forEach(function(f){var g=Math.abs(d.xScale.position(f[d.config.xDataKey])),h=Math.abs(d.xScale.position(f[d.config.xDataKey])+d.getRectWidth()),i=Math.abs(d.yScale.position(f[d.config.yDataKey])),j=Math.abs(d.yScale.position(f[d.config.yDataKey])+d.getRectHeight());b>=g&&h>=b&&c>=i&&j>=c&&(e={point:f,key:a.key,keyName:a.keyName})})}),e},d.drawRects=function(b,c){var e=d3.select(this).selectAll("rect").data(function(a){return a.values});e.enter().append("rect").attr("fill-opacity",d.config.fillOpacity).attr("x",function(a,b){return d.xScale.position(a[d.config.xDataKey])+d.config.barPadding}).attr("y",function(a){return d.yScale.position(a[d.config.yDataKey])}),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("stroke-width",d.config.strokeWidth).attr("fill",function(a,b){return d.config.colors[d.zScale(a[d.config.zDataKey])]}).attr("x",function(a,b){return d.xScale.position(a[d.config.xDataKey])+d.config.barPadding}).attr("y",function(a){return d.yScale.position(a[d.config.yDataKey])}).attr("width",d.getRectWidth()).attr("height",d.getRectHeight()),e.exit().remove()},d.getRectWidth=function(){return d.xScale.rangeBand()-d.config.barPadding},d.getRectHeight=function(){return d.yScale.rangeBand()-2*d.config.barPadding},d.setScales=function(){var b;sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id()),d.config.quantize===!1?d.zScale=d3.scale.identity(d3.range(0,d.config.buckets)):(b=d.data.reduce(function(a,b){return a.concat(b.values.map(function(a){return a[d.config.zDataKey]}))},[]),d.zScale=d3.scale.quantile().domain(b).range(d3.range(0,d.config.buckets)))},d.computeData=function(){sonic.isSet(d.config.seriesKey)?d.data=[a.dataByKey(d.config.seriesKey)]:sonic.isSet(d.config.seriesIndex)?d.data=[a.dataByIndex(d.config.seriesIndex)]:d.data=a.data()},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return"<p><b>"+d.config.xDataKey+": </b>"+a.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+": </b>"+a.point[d.config.yDataKey]+"<br /><b>"+d.config.zDataKey+": </b>"+a.point[d.config.zDataKey]+"</p>"},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-matrix",c),c},ma.add("addMatrix",V),sonic.comet=function(a,b){function c(b,e){var f;[d.config.cls,"sonic-comet"];d.selection=b,d.computeData(e||{}),d.setScales(),f=b.selectAll(".sonic-comet."+c.id()).data(d.data,function(a){return a.key}),f.enter().append("g").classed("sonic-comet "+c.id(),!0),f.attr("stroke",function(a){return a.stroke||a.color||d.config.stroke}).attr("stroke-width",function(a){return a.strokeWidth||d.config.strokeWidth}).attr("fill",function(a){return a.fill||a.color||d.config.fill}).attr("fill-opacity",function(a){return a.filOpacity||d.config.fillOpacity}),f.each(d.drawComets),f.each(d.setupLegend),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,config:{id:null,cls:"",definedDataKey:"id",xDataKey:"x",yDataKey:"y",xScaleId:null,
yScaleId:null,seriesKeys:null,seriesIndexes:null,stroke:"black",fill:"black",strokeWidth:3,fillOpacity:.8,gap:.05,headLength:.1,tailLength:.015}};return d.computeData=function(b){d.data=[],b.remove||(d.data=a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes).filter(function(a){return a.values.length>0}).map(function(a){return a.values=a.values.sort(function(a,b){return b[d.config.yDataKey]-a[d.config.yDataKey]}),a}))},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.cometGenerator=function(a){return function(b){function c(){var a={};return f.forEach(function(b,c){if(0>q){if(!(j>0))return!1;m>b.x&&(!a.pt||a.pt.x>b.x)&&(a.pt=b,a.idx=c)}else{if(!(0>j))return!1;m<b.x&&(!a.pt||a.pt.x<b.x)&&(a.pt=b,a.idx=c)}}),void 0!==a.idx?a:!1}function e(){var a={};return f.forEach(function(b,c){if(0>q){if(k>0)return!1;l<b.x&&(!a.pt||a.pt.x<b.x)&&(a.pt=b,a.idx=c)}else{if(!(k>0))return!1;l>b.x&&(!a.pt||a.pt.x>b.x)&&(a.pt=b,a.idx=c)}}),void 0!==a.idx?a:!1}var f,g,h,i,j,k,l,m,n,o,p,q,r=b.values,s=d.yScale.domain(),t=s[1]-s[0],u=(s[1]-s[0])/2,v=(t-u)*d.config.gap,w=d.xScale.rangeExtent();return f=r.map(function(a){return{x:d.xScale.position(a[d.config.xDataKey],"center"),y:(s[1]-s[0])/2+s[0]}}),q=f[0].x<f.slice(-1).x?-1:1,i=d3.range(v,t-u,(t-u-v)/f.length),g=f.map(function(a,b){return{x:a.x,y:d.yScale.position(a.y+i[i.length-1-b],"center")}}),h=f.reverse().map(function(a,b){return{x:a.x,y:d.yScale.position(a.y-i[b],"center")}}),j=g.reduce(function(a,b){return 0!==a?a:g[0].x-b.x},0),k=h.reduce(function(a,b){return 0!==a?a:h[0].x-b.x},0),l=0>k?h[0].x-d.config.tailLength*w:h[0].x+d.config.tailLength*w,m=0>j?g[0].x-d.config.headLength*w:g[0].x+d.config.headLength*w,n=c(),o=e(),"area"===a?p="M"+h.slice(o?o.idx:0,n?n.idx+1:h.length).map(function(a){return a.x+","+a.y}).join("L")+"L"+g[n?g.length-1-n.idx:0].x+","+g[n?g.length-1-n.idx:0].y+"L"+g.slice(n?g.length-1-n.idx:0,o?g.length-1-o.idx+1:g.length).map(function(a){return a.x+","+a.y}).join("L")+"L"+h[o?o.idx:0].x+","+h[o?o.idx:0].y:(p="M"+h.map(function(a){return a.x+","+a.y}).join("L")+"C"+m+","+h[h.length-1].y+" "+m+","+g[0].y+" "+g[0].x+","+g[0].y+"M"+g.map(function(a){return a.x+","+a.y}).join("L")+"C"+l+","+g[g.length-1].y+" "+l+","+h[0].y+" "+h[0].x+","+h[0].y,n&&(p=p+"M"+g[g.length-1-n.idx].x+","+g[g.length-1-n.idx].y+"L"+h[n.idx].x+","+h[n.idx].y)),p}},d.setupLegend=function(a,b){d.setupLegend=function(a,b){d3.select(this).selectAll("path").attr(c.id()+"-data-legend",function(b){return a.name||a.key})}},d.drawComets=function(b,c){var e,f,g=d3.select(this).selectAll("g.comet-cnt").data(d.data,function(a){return a.key});g.enter().append("g").classed("comet-cnt",!0),e=g.selectAll("path.area").data(d.data,function(a){return a.key}),e.enter().append("path").classed("area",!0),e.transition().duration(a.animation().delay).attr("d",d.cometGenerator("area")).attr("stroke",0),f=g.selectAll("path.outline").data(d.data,function(a){return a.key}),f.enter().append("path").classed("outline",!0),f.transition().duration(a.animation().delay).attr("d",d.cometGenerator()),e.exit().remove(),f.exit().remove(),g.exit().remove()},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),a.register("sonic-comet",c),c},ma.add("addComet",W),ma.add("updateComet",Y),ma.add("removeComet",X),sonic.area=function(a,b){function c(b,e){var f,g=[d.config.cls,"sonic-area",c.id()];d.selection=b,d.computeData(e||{}),d.setScales(),f=b.selectAll(g.join(".")).data(d.data,function(a){return a.key}),f.enter().insert("g").classed(g.join(" "),!0).append("path").attr("fill",d.config.startingFill),f.each(d.drawAreas),f.each(d.setupLegend),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,defaultColors:sonic.colors.colorMap(),config:{type:"basic",interpolator:"linear",offset:"zero",id:null,cls:"",definedDataKey:"id",xDataKey:"x",yDataKey:"y",xScaleId:null,yScaleId:null,seriesKeys:null,seriesIndexes:null,stroke:"black",fill:null,startingFill:"#FFF",sort:!1,animation:{duration:null,delay:null},strokeWidth:1,fillOpacity:1,tooltip:{buffer:{type:"value",amount:null},renderFn:null}}};return d.computeData=function(b){d.data=[],b.remove||(d.data=a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes),0!==d.data.length&&("stacked"===d.config.type&&d.computeStackedData(),d.data.forEach(function(a,b){a.index=b})))},d.computeStackedData=function(){var a,b;b=d3.layout.stack().values(function(a){return a.values}).x(function(a){return a[d.config.xDataKey]}).y(function(a){return a[d.config.yDataKey]}).offset(d.config.offset),a=sonic.array.unique(d.data.map(function(a){return a.values.map(function(a){return a[d.config.xDataKey]})})),d.data=sonic.clone(d.data).map(function(b){return a.forEach(function(a){var c={};sonic.array.contains(sonic.array.pluck(b.values,d.config.xDataKey),a)||(c[d.config.xDataKey]=a,c[d.config.yDataKey]=0,c.filler=!0,b.values.push(c))}),b.values.sort(sonic.sortByProp(d.config.xDataKey)),b}),d.data=b(d.data)},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id()),"stacked"===d.config.type?d.transitionAxisToStacked():d.transitionAxisToBasic()},d.transitionAxisToStacked=function(){var b=d.yScale.domainMin(),e=d.yScale.domainMax();0!==d.data.length&&(d.yScale.domainMin(d3.min(d.data,function(a){return d3.min(a.values,function(a){return a.y0})})),d.yScale.domainMax(d3.max(d.data,function(a){return d3.max(a.values,function(a){return a.y0+a[d.config.yDataKey]})})),(d.yScale.domainMax()!==e||d.yScale.domainMin()!==b)&&a.refreshRegistry(c.id()))},d.transitionAxisToBasic=function(){var b=d.yScale.domainMax();d.yScale.domainMax(d3.max(d.data,function(a){return d3.max(a.values,function(a){return a[d.config.yDataKey]})})),b!==d.yScale.domainMax()&&a.refreshRegistry(c.id())},d.setupLegend=function(a,b,d){d3.select(this).selectAll("path").attr(c.id()+"-data-legend",function(){return a.name||a.key})},d.drawAreas=function(b,c,e){var f=d.areaGenerator();d3.select(this).selectAll("path").data(d.data).transition().delay(a.animation().delay).duration(a.animation().duration).attr("fill",function(a,c){return d.getFillColor.call(this,a,c,b)}).attr("fill-opacity",d.config.fillOpacity).attr("stroke",function(a,c){var e=d.getFillColor.call(this,a,c,b);return e&&(e=d3.rgb(e).darker()),e}).attr("stroke-width",d.config.strokeWidth).attr("d",function(a){var c=b.values;return d.config.sort&&(c=d.xScale.sort(c)),f(c)})},d.areaGenerator=function(){return d3.svg.area().interpolate(d.config.interpolator).x(function(a){return d.xScale.position(a[d.config.xDataKey])}).y0(function(a){return"stacked"===d.config.type?d.yScale.position(a.y0):d.yScale.position(d.yScale.domainMin())}).y1(function(a){return"stacked"===d.config.type?d.yScale.position(a.y0+a[d.config.yDataKey]):d.yScale.position(a[d.config.yDataKey])})},d.getFillColor=function(b,c,e){var f=e.color||d.config.fill||d.defaultColors(e.index);return a.data()[e.index].colorLegend=f,f},d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),b},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),b},d.closestPoints=function(a){var b,c,e=[],f=a[0],g=a[1];if(sonic.isSet(d.config.tooltip.buffer.value)===!0){if(b=g>=d.yScale.rangeMin()&&g<=d.yScale.rangeMax(),b===!1)return[]}else c=!0;return(b||c)&&(e=d.data.map(function(a){var b={dist:null,point:null};return sonic.each(a,function(a,c){"values"!==a&&(b[a]=c)}),b}),d.data.forEach(function(a,b){a.values.forEach(function(a){var c=Math.abs(d.xScale.position(a[d.config.xDataKey],"center")-f);a.filler||(!e[b].point||c<e[b].dist)&&d.pointWithinBuffer(a,c)&&(e[b].point=a,e[b].dist=c)})}),e=e.filter(function(a){return sonic.isSet(a.point)?!0:!1})),e},d.pointWithinBuffer=function(a,b){var c=!0;return sonic.isSet(d.config.tooltip.buffer.amount)&&("value"===d.config.tooltip.buffer.type?d.xScale.domainRangeToInterval(b)>d.config.tooltip.buffer.amount&&(c=!1):b>d.config.tooltip.buffer.amount&&(c=!1)),c},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(b){var c="<p>";return(a.length>1||d.config.tooltip&&"global"===d.config.tooltip.type)&&(c=c+"<b><u>"+b.key+"</u></b><br />"),c=c+"<b>"+d.config.xDataKey+":</b>"+b.point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+":</b>"+b.point[d.config.yDataKey],c+"</p>"}).reduce(function(a,b){return a+b})},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-area",c),c},ma.add("addArea",Z),ma.add("addAreas",Z),ma.add("removeAreas",_),ma.add("updateAreas",$),sonic.pie=function(a,b){function c(b){var e,f;[d.config.cls,"sonic-pie"];d.selection=b,d.computeData(),d.computeRadii(),e=b.selectAll(".sonic-slice."+c.id()).data(d.data,function(a){return a.data.id}),f=e.enter().append("g").classed("sonic-slice "+c.id(),!0),e.attr("transform","translate("+a.body().width()/2+","+a.body().height()/2+")"),f.append("path").attr("d",d.arcGenerator()).style("fill",function(b,c){var e=b.data.color||d.config.colors(c);return a.data()[0].values[c].colorLegend=e,e}).attr("fill-opacity",1).attr("stroke-width",1).attr("stroke-opacity",1).attr("stroke",function(a,b){var c=a.data.color||d.config.colors(b);return d3.rgb(c).darker().toString()}).each(function(a){this._current=a}),f.append("text").attr("dy",".35em").style("text-anchor","middle").style("font-weight","bold"),e.each(d.updateSlice),e.exit().remove(),a.registerVisibleContent(c,c.hasContent)}var d={innerRadius:null,outerRadius:null,config:{id:null,innerRadius:null,outerRadius:null,yDataKey:"y",showLabels:!0,labelDataKey:"id",innerScale:.6,outerScale:.9,thresholdToLabel:.17,labelSize:null,colors:sonic.colors.colorMap(),tooltip:{buffer:null,type:"grouped"}}};return d.onVizClick=function(){},d.onVizMouseMove=function(a){var b=d.closestPoints(a);return d.updateTooltips(a,b),b},d.closestPoints=function(b){var e,f,g=[],h=b,i=[a.body().width()/2,a.body().height()/2],j=-1;if(h)switch(e=[h[0]-i[0],h[1]-i[1]],f=e[0]<0?e[1]<0?1:4:e[1]<0?2:3,e=e.map(function(a){return Math.abs(a)}),f){case 1:j=2*Math.PI-Math.atan(e[0]/e[1]);break;case 2:j=Math.atan(e[0]/e[1]);break;case 3:j=Math.PI-Math.atan(e[0]/e[1]);break;case 4:j=Math.PI+Math.atan(e[0]/e[1])}return d.selection.selectAll(".sonic-slice."+c.id()+" path").style("fill",function(b,c){var f=b.data.color||d.config.colors(c);return a.data()[0].values[c].colorLegend=f,d.isSliceSelected(b,j,e)?(g.push(b),d3.rgb(f).brighter().toString()):f}).attr("stroke",function(a,b){var c=a.data.color||d.config.colors(b);return d.isSliceSelected(a,j,e)?a.data.color||d.config.colors(b):c}).attr("stroke-width",function(a,b){return d.isSliceSelected(a,j,e)?2:1}),g},d.isSliceSelected=function(a,b,c){var e,f=!1;return sonic.isSet(a)&&sonic.isSet(a.startAngle)&&sonic.isSet(a.endAngle)&&sonic.isSet(c)&&sonic.isSet(c[0])&&sonic.isSet(c[1])?(e=sonic.geom.pythagorize(c[0],c[1]),e>=d.innerRadius&&e<=d.outerRadius&&b>=a.startAngle&&b<=a.endAngle):f},d.updateSlice=function(b,c){if(d3.select(this).select("path").transition().delay(a.animation().delay).duration(a.animation().duration).attrTween("d",d.arcTween).style("fill",function(b,c){var e=b.data.color||d.config.colors(c);return a.data()[0].values[c].colorLegend=e,e}),d.config.showLabels){var e=d3.select(this).select("text");e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("transform",function(a){return"translate("+d.arcGenerator().centroid(a)+")"}).text(function(a){return 180*(a.endAngle-a.startAngle)/Math.PI>100*d.config.thresholdToLabel?a.data[d.config.labelDataKey]:""}),d.config.labelSize&&e.style("font-size",d.config.labelSize)}},d.arcGenerator=function(){return d3.svg.arc().outerRadius(d.outerRadius).innerRadius(d.innerRadius)},d.arcTween=function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return d.arcGenerator()(b(a))}},d.computeData=function(){var b=d3.layout.pie().sort(null).value(function(a){return a[d.config.yDataKey]});a.data()&&a.data().length>0?(d.data=b(a.data()[0].values),a.data()[0].valueBased=!0):d.data=[]},d.computeRadii=function(){var b=Math.min(a.body().height(),a.body().width())/2;d.outerRadius=d.config.outerRadius||b*d.config.outerScale,d.innerRadius=d.config.innerRadius||b*d.config.innerScale},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e.length>0?(d.config.tooltip.closestPoints=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return a.map(function(a){var b="<p>";return b=b+"<b>"+a.data.id+": </b>"+((a.endAngle-a.startAngle)/(2*Math.PI)*100).toFixed(2)+"%<br />",b+"</p>"}).join("")},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-pie",c),c},ma.add("addPie",aa),sonic.hpie=function(a,b){function c(b,e){var f;[d.config.cls,"sonic-hpie"];d.selection=b,d.computeData(e||{}),f=b.selectAll(".sonic-hpie."+c.id()).data(d.data,function(a){return a.id||a.key+"series"}),f.enter().append("g").classed("sonic-hpie "+c.id(),!0),f.attr("transform",function(b){return"translate("+a.body().width()/2+","+a.body().height()/2+")"}),f.each(d.drawPie),d.config.labels.show&&f.each(d.drawLabels),f.exit().remove(),a.registerVisibleContent(c,c.hasContent)}var d={config:{id:null,seriesKey:null,colors:sonic.colors.colorMap(),tooltip:{},colorByKey:"group",labels:{show:!0,threshold:Math.PI/6,pointsPerPixel:1/6}}};return d.computeData=function(b){var c,e=d3.layout.partition().sort(null).size([2*Math.PI,Math.pow(Math.min(a.body().width(),a.body().height())/2,2)]).value(function(a){return a.size||1});d.data=[],b.remove||(c=a.dataBySeries(d.config.seriesKeys,null).filter(function(a,b){return a.values.length>0?!0:void 0}),d.data=c.map(function(a){return a.values=e.nodes(a.values[0]),a}))},d.arcGenerator=function(){return d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)})},d.arcTween=function(a){var b=d3.interpolate({x:this._current.x,dx:this._current.dx},a);return this._current=b(0),function(a){return d.arcGenerator()(b(a))}},d.updateSlice=function(b,c){d3.select(this).transition().delay(a.animation().delay).duration(a.animation().duration).attrTween("d",d.arcTween)},d.drawPie=function(a,b){var c=d3.select(this).selectAll(".pie-series").data(a.values,function(a){return a.name+"_"+a.id});c.enter().append("path").classed("pie-series",!0).attr("id",function(a){return a.id}).attr("d",d.arcGenerator()).style("fill",function(a,b){return a.color||d.config.colors(a[d.config.colorByKey]||a.name)}).attr("fill-opacity",1).attr("stroke-width",1).attr("stroke-opacity",1).attr("stroke",function(a,b){var c=a.color||d.config.colors(a[d.config.colorByKey]||a.name);return d3.rgb(c).darker().toString()}).each(function(a){this._current=a}),c.each(d.updateSlice),c.exit().remove()},d.drawLabels=function(a,b){var c=d3.select(this).selectAll(".sonic-hpie-labels").data(a.values,function(a){return a.name+"_"+a.id});c.enter().append("text").classed("sonic-hpie-labels",!0).attr("dy",20).attr("dx",10).style("font-weight","bold").append("textPath").classed("label-textpath",!0).attr("xlink:href",function(a){return"#"+a.id}),c.selectAll(".label-textpath").text(d.calcLabelText),c.exit().remove()},d.calcLabelText=function(a){var b=(Math.sqrt(a.y+a.dy)-Math.sqrt(a.y))/2+Math.sqrt(a.y),c=b*a.dx,e=Math.floor(c*d.config.labels.pointsPerPixel);return a.dx<d.config.labels.threshold||0===a.depth?"":a.name.length>e?a.name.substring(0,Math.max(3,e-3))+"...":a.name},d.calcLabelTranslate=function(a){var b=d.arcGenerator().centroid(a);return a.x===2*Math.PI?0:b},d.calcLabelRotation=function(a){var b,c=0,d=a.x+a.dx/2;if(a.dx===2*Math.PI)return 0;switch(b=d<=Math.PI/2?1:d<=Math.PI?4:d<=3*Math.PI/2?3:2){case 1:c=-1*(Math.PI/2-d)*180/Math.PI;break;case 4:c=180*(d-Math.PI/2)/Math.PI;break;case 3:c=-1*(3*Math.PI/2-d)*180/Math.PI;break;case 2:c=180*(d-3*Math.PI/2)/Math.PI}return c},c.highlightSlices=function(a){d.selection.selectAll(".pie-series").each(function(b){var c=sonic.object.keys(a).length>0?!0:!1;sonic.each(a,function(a,d){sonic.array.contains(d,b[a])||(c=!1)}),c?d3.select(this).classed("sonic-hpie-selected",!0):d3.select(this).classed("sonic-hpie-selected",!1)})},d.renderTooltips=function(a,b){return a.map(function(a){var b="<p>";return b=b+"<b>"+a.name+": </b>"+(a.dx/(2*Math.PI)*100).toFixed(2)+"% ("+a.value+")<br />",b+"</p>"}).join("")},d.onVizClick=function(a){var b=d.closestPoints(a);return b},d.onVizMouseMove=function(a){var b=d.closestPoints(a);return d.updateTooltips(a,b),d.selection.selectAll(".pie-series").each(function(a){sonic.array.contains(b,a)?d3.select(this).classed("sonic-hpie-hover",!0).attr("stroke",function(a){var b=a.color||d.config.colors(a[d.config.colorByKey]||a.name);return d3.rgb(b).darker().darker().toString()}).style("fill",function(a,b){var c=a.color||d.config.colors(a[d.config.colorByKey]||a.name);return d3.rgb(c).brighter().toString()}):d3.select(this).classed("sonic-hpie-hover",!1).style("fill",function(a,b){return a.color||d.config.colors(a[d.config.colorByKey]||a.name)}).attr("stroke",function(a){var b=a.color||d.config.colors(a[d.config.colorByKey]||a.name);return d3.rgb(b).darker().toString()})}),b},d.closestPoints=function(b){var c,e,f=[],g=b,h=[a.body().width()/2,a.body().height()/2],i=-1;if(g){switch(c=[g[0]-h[0],g[1]-h[1]],e=c[0]<0?c[1]<0?1:4:c[1]<0?2:3,c=c.map(function(a){return Math.abs(a)}),e){case 1:i=2*Math.PI-Math.atan(c[0]/c[1]);break;case 2:i=Math.atan(c[0]/c[1]);break;case 3:i=Math.PI-Math.atan(c[0]/c[1]);break;case 4:i=Math.PI+Math.atan(c[0]/c[1])}c=sonic.geom.pythagorize(c[0],c[1])}return d.data.forEach(function(a){sonic.each(a.values,function(a,b){d.isSliceSelected(i,c,b)&&f.push(b)})}),f},d.isSliceSelected=function(a,b,c){return a<c.x||a>c.x+c.dx?!1:b<Math.sqrt(c.y)||b>Math.sqrt(c.y+c.dy)?!1:!0},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-hpie",c),c},ma.add("addHPie",ba),ma.add("highlightSlices",ca),sonic.punchcard=function(a,b){function c(b,e){var f;[d.config.cls,"sonic-punchcard"];d.selection=b,d.computeData(e||{}),d.setScales(),f=b.selectAll(".sonic-punchcard."+c.id()).data(d.data,function(a){return a.key}),f.enter().append("g").classed("sonic-punchcard "+c.id(),!0),f.each(d.drawPunches),f.exit().remove(),a.registerVisibleContent(c,c.hasContent())}var d={xScale:null,yScale:null,min:null,max:null,config:{id:null,cls:"",xDataKey:"x",yDataKey:"y",zDataKey:"z",xScaleId:null,yScaleId:null,stroke:b&&b.fill&&!b.stroke?b.fill:"black",fill:b&&b.stroke&&!b.fill?b.stroke:"black",fillOpacity:1,radius:[2,10],clickable:!0,tooltip:{buffer:null,type:"grouped"}}};return c.hasContent=sonic.override(function(){var a=!1;return d.data.length>0&&d.data.forEach(function(b){return b.values.length>0?void(a=!0):void 0},this),a}),d.onVizMouseMove=function(a){var b;return a&&(b=d.closestPoints(a)),d.updateTooltips(a,b),d.selection.selectAll("circle:not(.selected)").classed("hovered",function(a,c){return sonic.isSet(b)?d.isClosestPoint(a,b):!1}).attr("fill",d.getPunchFill).attr("stroke",function(){return d3.rgb(d.getPunchFill.apply(this,arguments)).darker()}),b},d.onVizClick=function(a){var b;return a&&(b=d.closestPoints(a)),d.config.clickable&&d.selection.selectAll("circle").classed("selected",function(a,c){return sonic.isSet(b)?d.isClosestPoint(a,b):!1}).classed("hovered",!1).attr("fill",d.getPunchFill).attr("stroke",function(){return d3.rgb(d.getPunchFill.apply(this,arguments)).darker()}),b},d.closestPoints=function(a){var b,c=a[0],e=a[1];return b=d.data.map(function(a){return{key:a.key,dist:null,point:null}}),d.data.forEach(function(a,f){a.values.forEach(function(a){var g,h,i;g=d.xScale.position(a[d.config.xDataKey])+("ordinal"===d.xScale.type()?d.xScale.rangeBand()/2:0)-c,h=d.yScale.position(a[d.config.yDataKey])+("ordinal"===d.yScale.type()?d.yScale.rangeBand()/2:0)-e,i=Math.sqrt(g*g+h*h),(!b[f].point||i<b[f].dist)&&(b[f].point=a,b[f].dist=i)})}),b=b.reduce(function(a,b){return(0===a.length||b.dist<a[0].dist)&&sonic.isSet(b.point)?[b]:a},[])},d.setScales=function(){sonic.isSet(d.config.xScale)?(d.xScale=d.config.xScale,d.config.xScaleId=a.register("scale",d.xScale),delete d.config.xScale):d.config.xScaleId?d.xScale=a.findOne("scale",d.config.xScaleId):(d.xScale=a.findOne("scale",{dataKey:d.config.xDataKey}),d.config.xScaleId=d.xScale.id()),sonic.isSet(d.config.yScale)?(d.yScale=d.config.yScale,d.config.yScaleId=a.register("scale",d.yScale),delete d.config.yScale):d.config.yScaleId?d.yScale=a.findOne("scale",d.config.yScaleId):(d.yScale=a.findOne("scale",{dataKey:d.config.yDataKey}),d.config.yScaleId=d.yScale.id())},d.computeData=function(a){d.data=[],a.remove||(d.data=d.aggregateDuplicates(),d.calcExtrema())},d.aggregateDuplicates=function(){var b=[],c={},e=a.data();return e.forEach(function(a){b.push(a.key),a.values.forEach(function(a){var b=a[d.config.xDataKey]+"-"+a[d.config.yDataKey];c[b]?c[b][d.config.zDataKey]=c[b][d.config.zDataKey]+a[d.config.zDataKey]:c[b]=a})}),[{key:"aggregated:"+b.join("-"),values:Object.keys(c).map(function(a){return c[a]})}]},d.calcExtrema=function(){d.min=null,d.max=null,d.data.forEach(function(a){a.values.forEach(function(a){(!sonic.isSet(d.min)||a[d.config.zDataKey]<d.min)&&(d.min=a[d.config.zDataKey]),(!sonic.isSet(d.max)||a[d.config.zDataKey]>d.max)&&(d.max=a[d.config.zDataKey])})})},d.drawPunches=function(b,c){var e;e=d3.select(this).selectAll("circle").data(function(a){return a.values},function(a){return a.id}),e.enter().append("circle").attr("r",0),e.transition().delay(a.animation().delay).duration(a.animation().duration).attr("fill",d.getPunchFill).attr("fill-opacity",d.config.fillOpacity).attr("cx",function(a){return d.xScale.position(a[d.config.xDataKey])+("ordinal"===d.xScale.type()?d.xScale.rangeBand()/2:0)}).attr("cy",function(a){return d.yScale.position(a[d.config.yDataKey])+("ordinal"===d.yScale.type()?d.yScale.rangeBand()/2:0)}).attr("stroke",function(){return d3.rgb(d.getPunchFill.apply(this,arguments)).darker()}).attr("r",function(a){var b;return b=d.max!==d.min?(a[d.config.zDataKey]-d.min)/(d.max-d.min):.5,d.config.radius[0]+b*(d.config.radius[1]-d.config.radius[0])}),e.exit().remove()},d.updateTooltips=function(b,e){var f=d.config.tooltip.renderFn||d.renderTooltips;d.config.tooltip&&(b&&e?(d.config.tooltip.closestPoint=e,d.config.tooltip.content=f(e,b),d.config.tooltip.associatedId=c.id(),d.config.tooltip.mouse=b,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.renderTooltips=function(a,b){return 0===a.length?void 0:"<p><b>"+d.config.xDataKey+": </b>"+a[0].point[d.config.xDataKey]+"<br /><b>"+d.config.yDataKey+": </b>"+a[0].point[d.config.yDataKey]+"<br /><b>"+d.config.zDataKey+": </b>"+a[0].point[d.config.zDataKey]+"</p>"},d.isClosestPoint=function(a,b){var c=!1;return b.forEach(function(b){b.point&&b.point.id===a.id&&(c=!0)}),c},d.getSelected=function(a,b){return sonic.svg.hasClass(this,"selected")},d.getHovered=function(a,b){return sonic.svg.hasClass(this,"hovered")},d.getPunchFill=function(a,b){var c=d.config.fill;return sonic.isSet(d.data[0].color)&&(c=d.data[0].color),sonic.isSet(a.color)&&(c=a.color),(d.getSelected.call(this,a,b)||d.getHovered.call(this,a,b))&&(c=d3.rgb(c).brighter(3).toString()),c},sonic.augment(c,d,a,"registerable","listenable"),c.mergeConfig(b),a.register("sonic-punchcard",c),c},ma.add("addPunchcard",da),ma.add("addPunches",da),ma.add("updatePunchcard",fa),ma.add("updatePunches",fa),ma.add("removePunches",ea),sonic.geo={},sonic.geo.choropleth=function(a,b){function c(a,b){var e,f=[d.config.cls,"sonic-choropleth",c.id()];d.selection=a,d.computeProjection(),d.computePath(),d.computeZoom(),d.computeData(b),d.setScales(),e=a.selectAll(f.join(".")).data(data,function(a){return a.key}),e.enter().append("g").classed(f.join(" "),!0),e.each(d.drawGeos),e.exit().remove()}var d={scale:null,defaultColors:sonic.colors.colorMap(),projection:null,path:null,config:{id:null,cls:"",dataKey:"val",seriesKeys:null,seriesIndexes:null,colors:null,colorScheme:"Blues",buckets:9,baseGeos:{types:[],counties:{mesh:!1,fill:"#A4A4A4",stroke:"none"},states:{mesh:!0,fill:"none",stroke:"#FFF"},nielsen_zones:{mesh:!1,fill:"#A4A4A4",stroke:"#FFF"},topology:null},projection:{type:"albersUsa",scale:1070,translate:"center"},tooltip:{renderFn:null}}};return d.computeData=function(b){b=b||{},data=[],b.remove||(data=a.dataBySeries(d.config.seriesKeys,d.config.seriesIndexes))},d.setScales=function(){d.scale=d3.scale.quantile().domain(data.reduce(function(a,b){return a.concat(sonic.array.pluck(b.values,d.config.dataKey))},[])).range(d3.range(0,d.config.buckets))},d.drawGeos=function(a,b){var c=this,e=[{key:"countyId",type:"counties"},{key:"stateId",type:"states"},{key:"dmaId",type:"nielsen_zones"}];e.forEach(function(e){-1!==d.config.baseGeos.types.indexOf(e.type)&&(d.config.baseGeos[e.type].mesh?d.drawMeshFeature.call(c,e,a,b):d.drawMultiFeature.call(c,e,a,b))})},d.drawMeshFeature=function(a){var b,c=a.type;b=d3.select(this).selectAll("."+c).data([1]),b.enter().append("g").classed(c,!0).append("path"),b.select("path").datum(topojson.mesh(d.config.baseGeos.topology,d.config.baseGeos.topology.objects[c],function(a,b){return a!==b})).style("fill",d.config.baseGeos[c].fill).style("stroke",d.config.baseGeos[c].stroke).attr("d",d.path)},d.drawMultiFeature=function(b,c,e){var f,g,h=b.type,i=c.values;i.sort(sonic.sortByProp(b.key)),g=d3.select(this).selectAll("."+h).data([1]),g.enter().append("g").classed(h,!0),f=g.selectAll("path").data(topojson.feature(d.config.baseGeos.topology,d.config.baseGeos.topology.objects[h]).features,function(a){return a.id}),f.enter().append("path").on("mouseover",function(b,c){d3.select(this).classed("sonic-geo-polygon-highlight",!0),d.updateTooltips(b.id,a.mouse(this))}).on("mouseout",function(a,b){d3.select(this).classed("sonic-geo-polygon-highlight",!1),d.updateTooltips()}).on("click",d.handleClick),f.transition().delay(a.animation().delay).duration(a.animation().duration).style("stroke",d.config.baseGeos[h].stroke).style("fill",function(a){var e;return e=sonic.array.binarySearch(c.values,function(c){return c[b.key]<a.id?-1:c[b.key]>a.id?1:0}),d.getColor(sonic.isSet(e)?c.values[e][d.config.dataKey]:null)||d.config.baseGeos.counties.fill}).attr("d",d.path)},d.updateTooltips=function(b,e){var f,g=d.config.tooltip.renderFn||d.renderTooltips;e&&(f=d.closestPoints(b)),d.config.tooltip&&(sonic.isSet(b)?(d.config.tooltip.mouse=e,d.config.tooltip.associatedId=c.id(),d.config.tooltip.content=g(f,e),d.config.tooltip.cp=f,a.showTooltip(d.config.tooltip)):a.hideTooltip(d.config.tooltip))},d.closestPoints=function(a){var b=data[0].values;return b=b.filter(function(b){return b.dmaId===a})},d.renderTooltips=function(a,b){return"<p>id : "+a.dmaId},d.computeProjection=function(){var b=[a.body().width()/2,a.body().height()/2];d.projection?b=d.projection.translate():sonic.isArray(d.config.projection.translate)&&(b=d.config.projection.translate),d.projection=d3.geo[d.config.projection.type]().scale(d.projection?d.projection.scale():d.config.projection.scale).translate(b)},d.computePath=function(){d.path=d3.geo.path().projection(d.projection)},d.computeZoom=function(){a.body().call(d3.behavior.zoom().translate(d.projection.translate()).scale(d.projection.scale()).scaleExtent([a.body().height(),8*a.body().height()]).on("zoom",d.handleZoom))},d.getColor=function(a){var b,c=d.scale(a);if(a)return b=d.config.colors?d.config.colors[c]:colorbrewer?colorbrewer[d.config.colorScheme][Math.min(d.config.buckets,9)][c]:d.defaultColors(c)},d.handleClick=function(b){var c=d.path.centroid(b),e=d.projection.translate();d.projection.translate([e[0]-c[0]+a.body().width()/2,e[1]-c[1]+a.body().height()/2]),d.selection.selectAll("path").transition().duration(2e3).attr("d",d.path)},d.handleZoom=function(){d.projection.translate(d3.event.translate).scale(d3.event.scale),d.selection.selectAll("path").attr("d",d.path)},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),a.register("sonic-choropleth",c),c},ma.add("addChoropleth",ga),ma.add("updateChoropleth",ha),ma.add("removeChoropleth",ia),sonic.legend=function(a,b){function c(b,e){var f;a.container().selectAll(".sonic-legend."+c.id()).remove(),d.selection=b,d.computeData(e||{}),f=a.container().selectAll(".sonic-viz").data(d.data),f.enter().append("g").classed("sonic-legend "+c.id(),!0).style("font-size",d.config.style.fontSize).style("font-family",d.config.style.font),f.each(d.drawLegend),f.order(),f.exit().remove(),a.registerVisibleContent(c,!1)}var d={config:{legends:[],cls:"",style:{fill:"white",opacity:.8,fontSize:"10px",font:"sans-serif",fontColor:"black",padding:5,borderColor:"lightgray",borderWidth:1}}};return d.computeData=function(a){d.data=[],a.remove||(d.data=d.config.legends)},d.transformGraph=function(b,d){var e,f=a.margin(),g=!1,h=b[0][0].getBBox().height,i=b[0][0].getBBox().width,j="auto"===a.padding().left?0:a.padding().left,k=.5*(j+a.width())-.5*i,l=a.height(),m=0,n=0;switch(d){case"top":m=k,n=.05*l,e=h+10,f.top!==e&&(f.top=e,g=!0);break;case"bottom":m=k,n=.95*l,e=20,f.bottom!==e&&(f.bottom=e,g=!0);break;case"top-right":m=a.width()-i,n=.05*l,e=h+10,f.top!==e&&(f.top=e,g=!0);break;case"top-left":m=a.padding().left+10,n=.05*l,e=h+10,f.top!==e&&(f.top=e,g=!0);break;default:m=a.width()-135,n=.3*l,e=150,f.right!==e&&(f.right=e,g=!0)}return g&&a.margin(f,c.id()),b.attr("transform","translate("+m+","+n+")")},d.symbolGenerator=function(){return d3.svg.symbol().type(function(a){return a.type||a.symbolLegend||"circle"}).size(function(a){return a.size||64})},d.drawLegend=function(b){var c,e,f=d3.select(this),g=13.4,h=a.data().length>0&&a.data()[0].valueBased?a.data()[0].values:a.data(),i=(a.body(),d.config.style.padding),j=f.selectAll(".legend-box").data(h.length>0?[1]:[]),k=f.selectAll(".legend-items").data(h.length>0?[1]:[]),l=[],m=0,n=0,o=.3,p=b.pos;j.enter().append("rect").classed("legend-box",!0).style("fill",d.config.style.fill).style("opacity",d.config.style.opacity).style("stroke",d.config.style.borderColor).style("stroke-width",d.config.style.borderWidth),k.enter().append("g").classed("legend-group",!0),h=h.filter(function(a){return void 0!==a.colorLegend}),e=k.selectAll("g").data(h,function(a){return void 0===a.key?a.id:a.key}).enter().append("g").classed("legend-item",!0),e.append("text").attr("y",function(a,b){return b+"em"}).attr("x",13.4).attr("fill",d.config.style.fontColor).text(function(a){return void 0===a.key?a.id:a.key}).each(function(a){for(var b=d3.select(this),c=b.node().getComputedTextLength(),d=b.text(),e=120;c>e&&d.length>0&&"right"===p;)d=d.slice(0,-1),b.text(d+"..."),c=b.node().getComputedTextLength();
}),e.append("path").attr("transform",function(a,b){return"translate(0,"+(b-.25)+")"}).attr("d",d.symbolGenerator()).style("fill",function(a){return a.colorLegend}),("top"===b.pos||"bottom"===b.pos||"top-right"===b.pos||"top-left"===b.pos)&&(e.selectAll("text").attr("x",function(b,c){var d={x:g,y:o,cx:g-7,cy:n};return g+=this.getBBox().width+20,g>a.width()-a.currentPadding().left&&(d.x=13.4,d.cx=6.4,g=13.4+this.getBBox().width+20,o+=1.4,n+=14.3,d.y=o,d.cy=n),l.push(d),d.x}).attr("y",function(a,b){return m+=1,l[m-1].y+"em"}).call(function(){m=0}),e.selectAll("path").attr("transform",function(a,b){var c=l[m].cx,d=l[m].cy;return m+=1,"translate("+c+","+d+")"})),h.length>0&&(c=k[0][0].getBBox(),j.attr("x",c.x-i).attr("y",c.y-i).attr("height",c.height+2*i).attr("width",c.width+2*i)),f=d.transformGraph(f,b.pos),k.exit().remove(),j.exit().remove()},sonic.augment(c,d,a,"registerable"),c.mergeConfig(b),a.register("sonic-legend",c),c},ma.add("addLegend",ja),ma.add("updateLegend",la),ma.add("removeLegend",ka),sonic.viz=function(){function a(c){return sonic.svg.height(c)&&sonic.svg.width(c)?("auto"===b.config.sizeMode?(a.height(sonic.svg.height(c)),a.width(sonic.svg.width(c))):(a.height(b.config.height),a.width(b.config.width)),a.container().empty()&&(c.call(b.drawContainer),b.config.visibleClear===!0&&b.addClearLink(),b.addDefaultListeners()),a.container().attr("width",a.width()).attr("height",a.height()),a.body().data(b.data),b.translateBody(),b.registry.update(),void(b.hiddenUpdates=!1)):void(b.hiddenUpdates=!0)}var b={elId:null,api:null,registry:null,listener:null,tooltip:null,zoom:{zoomer:null,cbs:{zoomstart:{},zoom:{},zoomend:{}}},config:{sizeMode:"auto",width:null,height:null,margin:{top:10,right:10,bottom:7,left:7},currentPadding:{top:0,right:0,bottom:0,left:0},padding:{top:"auto",right:"auto",bottom:"auto",left:"auto"},animation:{delay:0,duration:1e3},tooltip:!1,noContentMessage:"No Data Available",visibleClear:!1},hiddenUpdates:!1};return b.api=ma,b.registry=sonic.registry(),b.listener=sonic.listener(a,b.registry),b.tooltip=sonic.tooltip(a),a.data=function(c,d){return sonic.isSet(d)||(d=!0),sonic.isSet(c)?(b.data=sonic.nest(c),d&&a.update(),a):b.data},a.dataByKey=function(b){var c=a.data().filter(function(a,c){return a.key===b?!0:void 0});return c.length>0?c[0]:void 0},a.dataByIndex=function(b){var c=a.data().filter(function(a,c){return c===b?!0:void 0});return c.length>0?c[0]:void 0},a.dataBySeries=function(b,c){return a.data().filter(function(a,d){var e=!1;return sonic.isSet(b)?sonic.isArray(b)?b.forEach(function(b){sonic.isRegex(b)?b.test(a.key)&&(e=!0):b===a.key&&(e=!0)}):sonic.isRegex(b)?b.test(a.key)&&(e=!0):b===a.key&&(e=!0):sonic.isSet(c)?sonic.isArray(c)&&-1!==c.indexOf(d)?e=!0:c===d&&(e=!0):e=!0,e})},a.width=function(c){return sonic.getOrSet("width",c,b.config,a)},a.height=function(c){return sonic.getOrSet("height",c,b.config,a)},a.container=function(){return b.selection.select(".sonic-viz")},a.margin=function(c,d){var e=sonic.getOrSet("margin",c,b.config,a);return sonic.isSet(c)&&a.refreshRegistry(d),b.translateBody(),e},a.currentPadding=function(c,d){var e=sonic.getOrSet("currentPadding",c,b.config,a);return sonic.isSet(c)&&sonic.isSet(d)&&(a.refreshRegistry(d),b.translateBody()),e},a.padding=function(){return b.config.padding},a.mouse=function(b){var c=d3.mouse(b),d=a.margin(),e=a.currentPadding();return[c[0]-d.left-e.left,c[1]-d.top-e.top]},a.mouse.inBody=function(b){return b[0]<=a.body().width()&&b[0]>=0&&b[1]<=a.body().height()&&b[1]>=0},a.body=function(){var c=a.container().select(".sonic-viz-body");return c.width=function(c){return a.width()-b.config.margin.left-b.config.margin.right-b.config.currentPadding.left-b.config.currentPadding.right},c.height=function(c){return a.height()-b.config.margin.top-b.config.margin.bottom-b.config.currentPadding.top-b.config.currentPadding.bottom},c},a.animation=function(c){return!sonic.isSet(c)&&b.hiddenUpdates?{duration:1e3,delay:0}:sonic.getOrSet("animation",c,b.config,a)},a.addZoom=function(c,d,e,f){b.zoom.zoomer||(b.zoom.zoomer=d3.behavior.zoom(),e&&b.zoom.zoomer.x(e.scale()),f&&b.zoom.zoomer.y(f.scale()),b.zoom.zoomer.on("zoomstart",b.zoomStartAction).on("zoom",b.zoomAction).on("zoomend",b.zoomEndAction),a.container().call(b.zoom.zoomer),a.container().selectAll(".sonic-clear-link").text("reset"),a.addListeners({".sonic-clear-link":{click:function(){b.zoom.zoomer.translate([0,0]).scale(1),b.zoomAction()}}})),e&&b.zoom.zoomer.x()!==e.scale()&&b.zoom.zoomer.x(e.scale()),f&&b.zoom.zoomer.y()!==f.scale()&&b.zoom.zoomer.y(f.scale()),b.setupZoomCallbacks(c,d)},a.getZoom=function(){return b.zoom},b.setupZoomCallbacks=function(a,c){sonic.each(c,function(c,d){b.zoom.cbs[c][a]=function(){d.fn(d.opts)}})},b.zoomStartAction=function(){b.zoom.holdAnimation=sonic.clone(a.animation()),a.animation({duration:0,delay:0}),a.container().select(".sonic-clear-link").style("display","block"),sonic.each(b.zoom.cbs.zoomstart,function(a,b){b()})},b.zoomAction=function(){sonic.each(b.zoom.cbs.zoom,function(a,b){b()}),a.find("sonic-axis").forEach(function(a){a.update()})},b.zoomEndAction=function(){sonic.each(b.zoom.cbs.zoomend,function(a,b){b()}),a.animation(b.zoom.holdAnimation)},a.refreshRegistry=b.registry.refresh,a.onBodyClick=function(b){a.container().select(".sonic-clear-link").style("display","block")},a.onClearClick=function(b){a.container().select(".sonic-clear-link").style("display","none")},a.clear=function(){a.onClearClick(),b.registry.applyFn("handleEvent",[".sonic-clear-link","click"])},a.tooltipSingleton=function(){return b.tooltip},a.listenerSingleton=function(){return b.listener},a.componentSingleton=function(){return b.registry},a.elId=function(){return b.elId},a.hasVisibleContent=function(){return b.registry.visibleContent().length>0},a.registry=function(){return b.registry},a.registerVisibleContent=function(c,d){b.registry.registerVisibleContent(c,d),a.drawNoContentMessage()},a.drawNoContentMessage=function(){var c=a.body().selectAll("text.nocontentmessage").data(a.hasVisibleContent()?[]:[1]);c.enter().append("text").classed("nocontentmessage",!0).style("text-anchor","middle").text(b.config.noContentMessage),c.attr("x",a.body().width()/2).attr("y",a.body().height()/2),c.exit().remove()},b.translateBody=function(){a.body().attr("transform","translate("+(b.config.margin.left+b.config.currentPadding.left)+","+(b.config.margin.top+b.config.currentPadding.top)+")")},b.init=function(c){b.elId=c[0],b.selection=d3.select(b.elId),c[1]&&(sonic.isArray(c[1])?a.data(c[1],!1):a.mergeConfig(c[1])),c[2]&&a.mergeConfig(c[2]),b.config.tooltip&&b.tooltip.mergeConfig(b.config.tooltip),(b.config.height||b.config.width)&&(b.config.sizeMode="manual"),b.bindAPIMethods(),a.update(),new ResizeSensor(b.selection[0][0],function(){a.update()})},b.drawContainer=function(a){a.append("svg").classed("sonic-viz",!0).append("g").classed("sonic-viz-body",!0).data(b.data)},b.bindAPIMethods=function(){b.api.methods().forEach(function(b,c){a[b]=function(){var b=c.apply(this,[a].concat(sonic.argsToArr(arguments)));return void 0!==b?b:a}})},b.addClearLink=function(){var b=a.container().selectAll(".sonic-clear-link").data([1]);b.enter().append("text").classed("sonic-clear-link",!0).text("clear").style("display","none"),b.attr("x",a.width()-a.margin().right-20).attr("y",a.height()-10)},b.addDefaultListeners=function(){return a.addListeners({vizbodywide:{mousemove:null,click:a.onBodyClick}}),b.config.visibleClear===!0&&a.addListeners({".sonic-clear-link":{click:a.onClearClick}}),a},sonic.augment(a,b,a,"registerable"),b.init(sonic.argsToArr(arguments)),a}}();